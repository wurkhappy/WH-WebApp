define(["backbone","handlebars","underscore","marionette","text!templates/agreement/discussion_tpl.html","views/agreement/comment_view","views/agreement/action_select"],function(e,t,n,r,i,s,o){var u=e.Marionette.CompositeView.extend({template:t.compile(i),itemView:s,itemViewOptions:function(e){return{agreement:this.model,user:this.user}},itemViewContainer:"ul",events:{"keypress input":"addComment","click .send_comment":"addComment","change #milestoneSelect":"updateMilestone","change #actionSelect":"updateStatus","focus select":"addSelectActive","blur select":"removeSelectActive","change select":"updateSelect"},initialize:function(e){this.userIsClient=window.thisUser.id===this.model.get("clientID"),this.collection=this.model.get("comments"),this.user=e.user},onRender:function(){this.actionSelect=(new o({collection:this.model.get("statusHistory").filterByPaymentID(this.milestone)})).render(),this.$("#action-select-wrapper").html(this.actionSelect.$el);var e=this.collection.at(this.collection.length-1);e&&(this.$("#milestoneSelect").val(e.get("milestoneID")).trigger("change"),this.$("#actionSelect").val(e.get("statusID")).trigger("change"))},addComment:function(e){var t=$("textarea.enter_comment_input");if(e.keyCode==13||e.type=="click"){var r=new this.collection.model({text:t.val(),dateCreated:moment(),userID:window.thisUser.id,milestoneID:this.milestone,statusID:this.status,agreementVersionID:this.collection.agreement.get("versionID")});this.collection.add(r),r.save(),t.val(""),t.focus(),$(".notification_container").last().fadeIn("slow").fadeOut(2e3),n.defer(function(){$(".discussion_container").scrollTop($(".discussion_container")[0].scrollHeight)})}},updateMilestone:function(e){this.milestone=e.target.value;var t=this.model.get("statusHistory").filterByPaymentID(this.milestone);this.actionSelect.collection=t,this.actionSelect.render()},updateStatus:function(e){this.status=e.target.value},updateSelect:function(e){var t=$(e.target),n=t.find(":selected").text();t.parent().find(".out").text(n)},addSelectActive:function(e){var t=$(e.target.parentNode);t.addClass("active_select")},removeSelectActive:function(e){var t=$(e.target.parentNode);t.removeClass("active_select")}});return u});