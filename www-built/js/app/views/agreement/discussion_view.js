define(["backbone","handlebars","underscore","marionette","jquery-ui","ckeditor","ckadapter","text!templates/agreement/discussion_tpl.html","views/agreement/comment_view","views/agreement/action_select","plugins/preventBackSpaceDefault","auto-grow"],function(e,t,n,r,i,s,o,u,a,f,l,c){l();var h=e.Marionette.CompositeView.extend({template:t.compile(u),itemView:a,itemViewOptions:function(e){return{agreement:this.model,user:this.user,otherUser:this.otherUser}},itemViewContainer:"ul",events:{"keypress input":"addComment","click .send_comment":"addComment","change #milestoneSelect":"updateMilestone","change #actionSelect":"updateStatus","focus select":"addSelectActive","blur select":"removeSelectActive","change select":"updateSelect","click .tag_filter":"toggleFilterActive","click .added_tag":"toggleTagActive","keyup .added_tag":"removeTag","focus .new_tag":"triggerAutoComplete","keydown .new_tag":"createNewTag","click .add_tag":"showTagInput"},initialize:function(e){this.userIsClient=window.thisUser.id===this.model.get("clientID"),this.collection=this.model.get("comments"),this.user=e.user,this.otherUser=e.otherUser},onRender:function(){this.actionSelect=(new f({collection:this.model.get("statusHistory").filterByPaymentID(this.milestone)})).render(),this.$("#action-select-wrapper").html(this.actionSelect.$el);var e=this.collection.at(this.collection.length-1);e&&(this.$("#milestoneSelect").val(e.get("milestoneID")).trigger("change"),this.$("#actionSelect").val(e.get("statusID")).trigger("change")),n.defer(function(e){s.replace("message_editor",{toolbar:[{items:["Bold","-","Italic","-","Underline"]}],disableNativeSpellChecker:!1,skin:"wurkhappy,/css/wurkhappy/"})})},addComment:function(e){var t=s.instances.message_editor,r=t.getData();if(e.type=="click"){var i=new this.collection.model({text:r,dateCreated:moment(),userID:window.thisUser.id,milestoneID:this.milestone,statusID:this.status,agreementVersionID:this.collection.agreement.get("versionID")});this.collection.add(i),i.save(),t.setData(""),$(".notification_container").last().fadeIn("slow").fadeOut(2e3),n.defer(function(){$(".discussion_container").scrollTop($(".discussion_container")[0].scrollHeight)})}},updateMilestone:function(e){this.milestone=e.target.value;var t=this.model.get("statusHistory").filterByPaymentID(this.milestone);this.actionSelect.collection=t,this.actionSelect.render()},updateStatus:function(e){this.status=e.target.value},updateSelect:function(e){var t=$(e.target),n=t.find(":selected").text();t.parent().find(".out").text(n)},addSelectActive:function(e){var t=$(e.target.parentNode);t.addClass("active_select")},removeSelectActive:function(e){var t=$(e.target.parentNode);t.removeClass("active_select")},toggleFilterActive:function(e){$(e.currentTarget).toggleClass("tag_filter_active")},toggleTagActive:function(e){$(".added_tag").removeClass("tag_active");var t=$(e.currentTarget);t.toggleClass("tag_active"),t.focus()},removeTag:function(e){e.preventDefault(),e.stopPropagation();var t=$(e.currentTarget);e.keyCode===8&&t.remove()},createNewTag:function(e){var t=$(e.currentTarget);e.keyCode===9&&e.preventDefault();if(t.val()==="")return;if(e.keyCode===13||e.keyCode===9){var n='<div class="inline added_tag new_added_tag" tabindex="-1">',r="</div>",i=n+t.val()+r;$(i).appendTo(".enter_tags_sub_container"),t.val(""),t.hide()}},showTagInput:function(e){var t=$(".new_tag");t.show(),t.focus()},triggerAutoComplete:function(e){var t=["writing","wireframes","2nd payment","update","product page","footer","header","waffle","candy"];$(".new_tag").autocomplete({source:t}),this.triggerAutoGrow()},triggerAutoGrow:function(e){$(".new_tag").autoGrow({comfortZone:3})}});return h});