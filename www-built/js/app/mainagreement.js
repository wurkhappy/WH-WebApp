/*! wurk-happy v0.0.1 | 25-11-2013-01:17:01
 * Copyright (c) 2013 |// MarionetteJS (Backbone.Marionette)
// ----------------------------------
// v1.0.4
//
// Copyright (c)2013 Derick Bailey, Muted Solutions, LLC.
// Distributed under MIT license
//
// http://marionettejs.com

/*!
 * Includes BabySitter
 * https://github.com/marionettejs/backbone.babysitter/
 *
 * Includes Wreqr
 * https://github.com/marionettejs/backbone.wreqr/
 */

// Backbone.BabySitter
// -------------------
// v0.0.6
//
// Copyright (c)2013 Derick Bailey, Muted Solutions, LLC.
// Distributed under MIT license
//
// http://github.com/babysitterjs/backbone.babysitter

// Backbone.Wreqr (Backbone.Marionette)
// ----------------------------------
// v0.2.0
//
// Copyright (c)2013 Derick Bailey, Muted Solutions, LLC.
// Distributed under MIT license
//
// http://github.com/marionettejs/backbone.wreqr

/********************************************************************
 *	Kalendae, a framework agnostic javascript date picker           *
 *	Copyright(c) 2013 Jarvis Badgley (chipersoft@gmail.com)         *
 *	http://github.com/ChiperSoft/Kalendae                           *
 *	Version 0.4.1                                                   *
 ********************************************************************/

/**
 * noty - jQuery Notification Plugin v2.1.0
 * Contributors: https://github.com/needim/noty/graphs/contributors
 *
 * Examples and Documentation - http://needim.github.com/noty/
 *
 * Licensed under the MIT licenses:
 * http://www.opensource.org/licenses/mit-license.php
 *
 **/

(function(e){var t,n,r;typeof window=="undefined"?(t=require("underscore"),n=require("backbone"),r=n,typeof module=="undefined"||(module.exports=r)):(t=window._,n=window.Backbone,r=window),n.Relational={showWarnings:!0},n.Semaphore={_permitsAvailable:null,_permitsUsed:0,acquire:function(){if(this._permitsAvailable&&this._permitsUsed>=this._permitsAvailable)throw new Error("Max permits acquired");this._permitsUsed++},release:function(){if(this._permitsUsed===0)throw new Error("All permits released");this._permitsUsed--},isLocked:function(){return this._permitsUsed>0},setAvailablePermits:function(e){if(this._permitsUsed>e)throw new Error("Available permits cannot be less than used permits");this._permitsAvailable=e}},n.BlockingQueue=function(){this._queue=[]},t.extend(n.BlockingQueue.prototype,n.Semaphore,{_queue:null,add:function(e){this.isBlocked()?this._queue.push(e):e()},process:function(){var e=this._queue;this._queue=[];while(e&&e.length)e.shift()()},block:function(){this.acquire()},unblock:function(){this.release(),this.isBlocked()||this.process()},isBlocked:function(){return this.isLocked()}}),n.Relational.eventQueue=new n.BlockingQueue,n.Store=function(){this._collections=[],this._reverseRelations=[],this._orphanRelations=[],this._subModels=[],this._modelScopes=[r]},t.extend(n.Store.prototype,n.Events,{initializeRelation:function(e,r,i){var s=t.isString(r.type)?n[r.type]||this.getObjectByName(r.type):r.type;s&&s.prototype instanceof n.Relation?new s(e,r,i):n.Relational.showWarnings&&typeof console!="undefined"&&console.warn("Relation=%o; missing or invalid relation type!",r)},addModelScope:function(e){this._modelScopes.push(e)},removeModelScope:function(e){this._modelScopes=t.without(this._modelScopes,e)},addSubModels:function(e,t){this._subModels.push({superModelType:t,subModels:e})},setupSuperModel:function(e){t.find(this._subModels,function(n){return t.find(n.subModels||[],function(t,r){var i=this.getObjectByName(t);if(e===i)return n.superModelType._subModels[r]=e,e._superModel=n.superModelType,e._subModelTypeValue=r,e._subModelTypeAttribute=n.superModelType.prototype.subModelTypeAttribute,!0},this)},this)},addReverseRelation:function(e){var n=t.any(this._reverseRelations,function(n){return t.all(e||[],function(e,t){return e===n[t]})});!n&&e.model&&e.type&&(this._reverseRelations.push(e),this._addRelation(e.model,e),this.retroFitRelation(e))},addOrphanRelation:function(e){var n=t.any(this._orphanRelations,function(n){return t.all(e||[],function(e,t){return e===n[t]})});!n&&e.model&&e.type&&this._orphanRelations.push(e)},processOrphanRelations:function(){t.each(this._orphanRelations.slice(0),function(e){var r=n.Relational.store.getObjectByName(e.relatedModel);r&&(this.initializeRelation(null,e),this._orphanRelations=t.without(this._orphanRelations,e))},this)},_addRelation:function(e,n){e.prototype.relations||(e.prototype.relations=[]),e.prototype.relations.push(n),t.each(e._subModels||[],function(e){this._addRelation(e,n)},this)},retroFitRelation:function(e){var t=this.getCollection(e.model,!1);t&&t.each(function(t){if(!(t instanceof e.model))return;new e.type(t,e)},this)},getCollection:function(e,r){e instanceof n.RelationalModel&&(e=e.constructor);var i=e;while(i._superModel)i=i._superModel;var s=t.find(this._collections,function(e){return e.model===i});return!s&&r!==!1&&(s=this._createCollection(i)),s},getObjectByName:function(n){var r=n.split("."),i=null;return t.find(this._modelScopes,function(n){i=t.reduce(r||[],function(t,n){return t?t[n]:e},n);if(i&&i!==n)return!0},this),i},_createCollection:function(e){var t;return e instanceof n.RelationalModel&&(e=e.constructor),e.prototype instanceof n.RelationalModel&&(t=new n.Collection,t.model=e,this._collections.push(t)),t},resolveIdForItem:function(e,r){var i=t.isString(r)||t.isNumber(r)?r:null;return i===null&&(r instanceof n.RelationalModel?i=r.id:t.isObject(r)&&(i=r[e.prototype.idAttribute])),!i&&i!==0&&(i=null),i},find:function(e,t){var n=this.resolveIdForItem(e,t),r=this.getCollection(e);if(r){var i=r.get(n);if(i instanceof e)return i}return null},register:function(e){var t=this.getCollection(e);if(t){var n=e.collection;t.add(e),this.listenTo(e,"destroy",this.unregister,this),this.listenTo(e,"relational:unregister",this.unregister,this),e.collection=n}},checkId:function(e,t){var r=this.getCollection(e),i=r&&r.get(t);if(i&&e!==i)throw n.Relational.showWarnings&&typeof console!="undefined"&&console.warn("Duplicate id! Old RelationalModel=%o, new RelationalModel=%o",i,e),new Error("Cannot instantiate more than one Backbone.RelationalModel with the same id per type!")},update:function(e){var t=this.getCollection(e);t._onModelEvent("change:"+e.idAttribute,e,t),e.trigger("relational:change:id",e,t)},unregister:function(e,t,n){this.stopListening(e);var r=this.getCollection(e);r&&r.remove(e,n)},reset:function(){this.stopListening(),this._collections=[],this._subModels=[],this._modelScopes=[r]}}),n.Relational.store=new n.Store,n.Relation=function(e,r,i){this.instance=e,r=t.isObject(r)?r:{},this.reverseRelation=t.defaults(r.reverseRelation||{},this.options.reverseRelation),this.options=t.defaults(r,this.options,n.Relation.prototype.options),this.reverseRelation.type=t.isString(this.reverseRelation.type)?n[this.reverseRelation.type]||n.Relational.store.getObjectByName(this.reverseRelation.type):this.reverseRelation.type,this.key=this.options.key,this.keySource=this.options.keySource||this.key,this.keyDestination=this.options.keyDestination||this.keySource||this.key,this.model=this.options.model||this.instance.constructor,this.relatedModel=this.options.relatedModel,t.isFunction(this.relatedModel)&&!(this.relatedModel.prototype instanceof n.RelationalModel)&&(this.relatedModel=t.result(this,"relatedModel")),t.isString(this.relatedModel)&&(this.relatedModel=n.Relational.store.getObjectByName(this.relatedModel));if(!this.checkPreconditions())return;!this.options.isAutoRelation&&this.reverseRelation.type&&this.reverseRelation.key&&n.Relational.store.addReverseRelation(t.defaults({isAutoRelation:!0,model:this.relatedModel,relatedModel:this.model,reverseRelation:this.options},this.reverseRelation));if(e){var s=this.keySource;s!==this.key&&typeof this.instance.get(this.key)=="object"&&(s=this.key),this.setKeyContents(this.instance.get(s)),this.relatedCollection=n.Relational.store.getCollection(this.relatedModel),this.keySource!==this.key&&delete this.instance.attributes[this.keySource],this.instance._relations[this.key]=this,this.initialize(i),this.options.autoFetch&&this.instance.fetchRelated(this.key,t.isObject(this.options.autoFetch)?this.options.autoFetch:{}),this.listenTo(this.instance,"destroy",this.destroy).listenTo(this.relatedCollection,"relational:add relational:change:id",this.tryAddRelated).listenTo(this.relatedCollection,"relational:remove",this.removeRelated)}},n.Relation.extend=n.Model.extend,t.extend(n.Relation.prototype,n.Events,n.Semaphore,{options:{createModels:!0,includeInJSON:!0,isAutoRelation:!1,autoFetch:!1,parse:!1},instance:null,key:null,keyContents:null,relatedModel:null,relatedCollection:null,reverseRelation:null,related:null,checkPreconditions:function(){var e=this.instance,r=this.key,i=this.model,s=this.relatedModel,o=n.Relational.showWarnings&&typeof console!="undefined";if(!i||!r||!s)return o&&console.warn("Relation=%o: missing model, key or relatedModel (%o, %o, %o).",this,i,r,s),!1;if(i.prototype instanceof n.RelationalModel){if(s.prototype instanceof n.RelationalModel){if(this instanceof n.HasMany&&this.reverseRelation.type===n.HasMany)return o&&console.warn("Relation=%o: relation is a HasMany, and the reverseRelation is HasMany as well.",this),!1;if(e&&t.keys(e._relations).length){var u=t.find(e._relations,function(e){return e.key===r},this);if(u)return o&&console.warn("Cannot create relation=%o on %o for model=%o: already taken by relation=%o.",this,r,e,u),!1}return!0}return o&&console.warn("Relation=%o: relatedModel does not inherit from Backbone.RelationalModel (%o).",this,s),!1}return o&&console.warn("Relation=%o: model does not inherit from Backbone.RelationalModel (%o).",this,e),!1},setRelated:function(e){this.related=e,this.instance.acquire(),this.instance.attributes[this.key]=e,this.instance.release()},_isReverseRelation:function(e){return e.instance instanceof this.relatedModel&&this.reverseRelation.key===e.key&&this.key===e.reverseRelation.key},getReverseRelations:function(e){var n=[],r=t.isUndefined(e)?this.related&&(this.related.models||[this.related]):[e];return t.each(r||[],function(e){t.each(e.getRelations()||[],function(e){this._isReverseRelation(e)&&n.push(e)},this)},this),n},destroy:function(){this.stopListening(),this instanceof n.HasOne?this.setRelated(null):this instanceof n.HasMany&&this.setRelated(this._prepareCollection()),t.each(this.getReverseRelations(),function(e){e.removeRelated(this.instance)},this)}}),n.HasOne=n.Relation.extend({options:{reverseRelation:{type:"HasMany"}},initialize:function(e){this.listenTo(this.instance,"relational:change:"+this.key,this.onChange);var n=this.findRelated(e);this.setRelated(n),t.each(this.getReverseRelations(),function(t){t.addRelated(this.instance,e)},this)},findRelated:function(e){var n=null;e=t.defaults({parse:this.options.parse},e);if(this.keyContents instanceof this.relatedModel)n=this.keyContents;else if(this.keyContents||this.keyContents===0){var r=t.defaults({create:this.options.createModels},e);n=this.relatedModel.findOrCreate(this.keyContents,r)}return this.related&&(this.keyId=null),n},setKeyContents:function(e){this.keyContents=e,this.keyId=n.Relational.store.resolveIdForItem(this.relatedModel,this.keyContents)},onChange:function(e,r,i){if(this.isLocked())return;this.acquire(),i=i?t.clone(i):{};var s=t.isUndefined(i.__related),o=s?this.related:i.__related;if(s){this.setKeyContents(r);var u=this.findRelated(i);this.setRelated(u)}o&&this.related!==o&&t.each(this.getReverseRelations(o),function(e){e.removeRelated(this.instance,null,i)},this),t.each(this.getReverseRelations(),function(e){e.addRelated(this.instance,i)},this);if(!i.silent&&this.related!==o){var a=this;this.changed=!0,n.Relational.eventQueue.add(function(){a.instance.trigger("change:"+a.key,a.instance,a.related,i,!0),a.changed=!1})}this.release()},tryAddRelated:function(e,t,n){(this.keyId||this.keyId===0)&&e.id===this.keyId&&(this.addRelated(e,n),this.keyId=null)},addRelated:function(e,n){var r=this;e.queue(function(){if(e!==r.related){var i=r.related||null;r.setRelated(e),r.onChange(r.instance,e,t.defaults({__related:i},n))}})},removeRelated:function(e,n,r){if(!this.related)return;if(e===this.related){var i=this.related||null;this.setRelated(null),this.onChange(this.instance,e,t.defaults({__related:i},r))}}}),n.HasMany=n.Relation.extend({collectionType:null,options:{reverseRelation:{type:"HasOne"},collectionType:n.Collection,collectionKey:!0,collectionOptions:{}},initialize:function(e){this.listenTo(this.instance,"relational:change:"+this.key,this.onChange),this.collectionType=this.options.collectionType,t.isFunction(this.collectionType)&&this.collectionType!==n.Collection&&!(this.collectionType.prototype instanceof n.Collection)&&(this.collectionType=t.result(this,"collectionType")),t.isString(this.collectionType)&&(this.collectionType=n.Relational.store.getObjectByName(this.collectionType));if(!(this.collectionType===n.Collection||this.collectionType.prototype instanceof n.Collection))throw new Error("`collectionType` must inherit from Backbone.Collection");var r=this.findRelated(e);this.setRelated(r)},_prepareCollection:function(e){this.related&&this.stopListening(this.related);if(!e||!(e instanceof n.Collection)){var r=t.isFunction(this.options.collectionOptions)?this.options.collectionOptions(this.instance):this.options.collectionOptions;e=new this.collectionType(null,r)}e.model=this.relatedModel;if(this.options.collectionKey){var i=this.options.collectionKey===!0?this.options.reverseRelation.key:this.options.collectionKey;e[i]&&e[i]!==this.instance?n.Relational.showWarnings&&typeof console!="undefined"&&console.warn("Relation=%o; collectionKey=%s already exists on collection=%o",this,i,this.options.collectionKey):i&&(e[i]=this.instance)}return this.listenTo(e,"relational:add",this.handleAddition).listenTo(e,"relational:remove",this.handleRemoval).listenTo(e,"relational:reset",this.handleReset),e},findRelated:function(e){var r=null;e=t.defaults({parse:this.options.parse},e);if(this.keyContents instanceof n.Collection)this._prepareCollection(this.keyContents),r=this.keyContents;else{var i=[];t.each(this.keyContents,function(n){if(n instanceof this.relatedModel)var r=n;else r=this.relatedModel.findOrCreate(n,t.extend({merge:!0},e,{create:this.options.createModels}));r&&i.push(r)},this),this.related instanceof n.Collection?r=this.related:r=this._prepareCollection(),r.set(i,t.defaults({merge:!1,parse:!1},e))}return this.keyIds=t.difference(this.keyIds,t.pluck(r.models,"id")),r},setKeyContents:function(e){this.keyContents=e instanceof n.Collection?e:null,this.keyIds=[],!this.keyContents&&(e||e===0)&&(this.keyContents=t.isArray(e)?e:[e],t.each(this.keyContents,function(e){var t=n.Relational.store.resolveIdForItem(this.relatedModel,e);(t||t===0)&&this.keyIds.push(t)},this))},onChange:function(e,r,i){i=i?t.clone(i):{},this.setKeyContents(r),this.changed=!1;var s=this.findRelated(i);this.setRelated(s);if(!i.silent){var o=this;n.Relational.eventQueue.add(function(){o.changed&&(o.instance.trigger("change:"+o.key,o.instance,o.related,i,!0),o.changed=!1)})}},handleAddition:function(e,r,i){i=i?t.clone(i):{},this.changed=!0,t.each(this.getReverseRelations(e),function(e){e.addRelated(this.instance,i)},this);var s=this;!i.silent&&n.Relational.eventQueue.add(function(){s.instance.trigger("add:"+s.key,e,s.related,i)})},handleRemoval:function(e,r,i){i=i?t.clone(i):{},this.changed=!0,t.each(this.getReverseRelations(e),function(e){e.removeRelated(this.instance,null,i)},this);var s=this;!i.silent&&n.Relational.eventQueue.add(function(){s.instance.trigger("remove:"+s.key,e,s.related,i)})},handleReset:function(e,r){var i=this;r=r?t.clone(r):{},!r.silent&&n.Relational.eventQueue.add(function(){i.instance.trigger("reset:"+i.key,i.related,r)})},tryAddRelated:function(e,n,r){var i=t.contains(this.keyIds,e.id);i&&(this.addRelated(e,r),this.keyIds=t.without(this.keyIds,e.id))},addRelated:function(e,n){var r=this;e.queue(function(){r.related&&!r.related.get(e)&&r.related.add(e,t.defaults({parse:!1},n))})},removeRelated:function(e,t,n){this.related.get(e)&&this.related.remove(e,n)}}),n.RelationalModel=n.Model.extend({relations:null,_relations:null,_isInitialized:!1,_deferProcessing:!1,_queue:null,_attributeChangeFired:!1,subModelTypeAttribute:"type",subModelTypes:null,constructor:function(e,r){if(r&&r.collection){var i=this,s=this.collection=r.collection;delete r.collection,this._deferProcessing=!0;var o=function(e){e===i&&(i._deferProcessing=!1,i.processQueue(),s.off("relational:add",o))};s.on("relational:add",o),t.defer(function(){o(i)})}n.Relational.store.processOrphanRelations(),this._queue=new n.BlockingQueue,this._queue.block(),n.Relational.eventQueue.block();try{n.Model.apply(this,arguments)}finally{n.Relational.eventQueue.unblock()}},trigger:function(e){if(e.length>5&&e.indexOf("change")===0){var t=this,r=arguments;n.Relational.eventQueue.add(function(){if(!t._isInitialized)return;var i=!0;if(e==="change")i=t.hasChanged()||t._attributeChangeFired,t._attributeChangeFired=!1;else{var s=e.slice(7),o=t.getRelation(s);o?(i=r[4]===!0,i?t.changed[s]=r[2]:o.changed||delete t.changed[s]):i&&(t._attributeChangeFired=!0)}i&&n.Model.prototype.trigger.apply(t,r)})}else n.Model.prototype.trigger.apply(this,arguments);return this},initializeRelations:function(e){this.acquire(),this._relations={},t.each(t.result(this,"relations")||[],function(t){n.Relational.store.initializeRelation(this,t,e)},this),this._isInitialized=!0,this.release(),this.processQueue()},updateRelations:function(e){this._isInitialized&&!this.isLocked()&&t.each(this._relations,function(t){var n=this.attributes[t.keySource]||this.attributes[t.key];t.related!==n&&this.trigger("relational:change:"+t.key,this,n,e||{}),t.keySource!==t.key&&delete t.instance.attributes[t.keySource]},this)},queue:function(e){this._queue.add(e)},processQueue:function(){this._isInitialized&&!this._deferProcessing&&this._queue.isBlocked()&&this._queue.unblock()},getRelation:function(e){return this._relations[e]},getRelations:function(){return t.values(this._relations)},fetchRelated:function(e,r,i){r=t.extend({update:!0,remove:!1},r);var s,o=[],u=this.getRelation(e),a=u&&(u.keyIds&&u.keyIds.slice(0)||(u.keyId||u.keyId===0?[u.keyId]:[]));if(i){var f=u.related instanceof n.Collection?u.related.models:[u.related];t.each(f,function(e){(e.id||e.id===0)&&a.push(e.id)})}if(a&&a.length){var l=[],f=t.map(a,function(e){var t=n.Relational.store.find(u.relatedModel,e);if(!t){var i={};i[u.relatedModel.prototype.idAttribute]=e,t=u.relatedModel.findOrCreate(i,r),l.push(t)}return t},this);u.related instanceof n.Collection&&t.isFunction(u.related.url)&&(s=u.related.url(f));if(s&&s!==u.related.url()){var c=t.defaults({error:function(){var e=arguments;t.each(l,function(t){t.trigger("destroy",t,t.collection,r),r.error&&r.error.apply(t,e)})},url:s},r);o=[u.related.fetch(c)]}else o=t.map(f,function(e){var n=t.defaults({error:function(){t.contains(l,e)&&(e.trigger("destroy",e,e.collection,r),r.error&&r.error.apply(e,arguments))}},r);return e.fetch(n)},this)}return o},get:function(r){var i=n.Model.prototype.get.call(this,r);if(!this.dotNotation||r.indexOf(".")===-1)return i;var s=r.split("."),o=t.reduce(s,function(r,i){if(t.isNull(r)||t.isUndefined(r))return e;if(r instanceof n.Model)return n.Model.prototype.get.call(r,i);if(r instanceof n.Collection)return n.Collection.prototype.at.call(r,i);throw new Error("Attribute must be an instanceof Backbone.Model or Backbone.Collection. Is: "+r+", currentSplit: "+i)},this);if(i!==e&&o!==e)throw new Error("Ambiguous result for '"+r+"'. direct result: "+i+", dotNotation: "+o);return i||o},set:function(e,r,i){n.Relational.eventQueue.block();var s;t.isObject(e)||e==null?(s=e,i=r):(s={},s[e]=r);try{var o=this.id,u=s&&this.idAttribute in s&&s[this.idAttribute];n.Relational.store.checkId(this,u);var a=n.Model.prototype.set.apply(this,arguments);!this._isInitialized&&!this.isLocked()?(this.constructor.initializeModelHierarchy(),n.Relational.store.register(this),this.initializeRelations(i)):u&&u!==o&&n.Relational.store.update(this),s&&this.updateRelations(i)}finally{n.Relational.eventQueue.unblock()}return a},clone:function(){var e=t.clone(this.attributes);return t.isUndefined(e[this.idAttribute])||(e[this.idAttribute]=null),t.each(this.getRelations(),function(t){delete e[t.key]}),new this.constructor(e)},toJSON:function(e){if(this.isLocked())return this.id;this.acquire();var r=n.Model.prototype.toJSON.call(this,e);return this.constructor._superModel&&!(this.constructor._subModelTypeAttribute in r)&&(r[this.constructor._subModelTypeAttribute]=this.constructor._subModelTypeValue),t.each(this._relations,function(i){var s=r[i.key],o=i.options.includeInJSON,u=null;o===!0?s&&t.isFunction(s.toJSON)&&(u=s.toJSON(e)):t.isString(o)?(s instanceof n.Collection?u=s.pluck(o):s instanceof n.Model&&(u=s.get(o)),o===i.relatedModel.prototype.idAttribute&&(i instanceof n.HasMany?u=u.concat(i.keyIds):i instanceof n.HasOne&&(u=u||i.keyId))):t.isArray(o)?s instanceof n.Collection?(u=[],s.each(function(e){var n={};t.each(o,function(t){n[t]=e.get(t)}),u.push(n)})):s instanceof n.Model&&(u={},t.each(o,function(e){u[e]=s.get(e)})):delete r[i.key],o&&(r[i.keyDestination]=u),i.keyDestination!==i.key&&delete r[i.key]}),this.release(),r}},{setup:function(e){return this.prototype.relations=(this.prototype.relations||[]).slice(0),this._subModels={},this._superModel=null,this.prototype.hasOwnProperty("subModelTypes")?n.Relational.store.addSubModels(this.prototype.subModelTypes,this):this.prototype.subModelTypes=null,t.each(this.prototype.relations||[],function(e){e.model||(e.model=this);if(e.reverseRelation&&e.model===this){var r=!0;if(t.isString(e.relatedModel)){var i=n.Relational.store.getObjectByName(e.relatedModel);r=i&&i.prototype instanceof n.RelationalModel}r?n.Relational.store.initializeRelation(null,e):t.isString(e.relatedModel)&&n.Relational.store.addOrphanRelation(e)}},this),this},build:function(e,t){this.initializeModelHierarchy();var n=this._findSubModelType(this,e)||this;return new n(e,t)},_findSubModelType:function(e,t){if(e._subModels&&e.prototype.subModelTypeAttribute in t){var n=t[e.prototype.subModelTypeAttribute],r=e._subModels[n];if(r)return r;for(n in e._subModels){r=this._findSubModelType(e._subModels[n],t);if(r)return r}}return null},initializeModelHierarchy:function(){this.inheritRelations();if(this.prototype.subModelTypes){var e=t.keys(this._subModels),r=t.omit(this.prototype.subModelTypes,e);t.each(r,function(e){var t=n.Relational.store.getObjectByName(e);t&&t.initializeModelHierarchy()})}},inheritRelations:function(){if(!t.isUndefined(this._superModel)&&!t.isNull(this._superModel))return;n.Relational.store.setupSuperModel(this);if(this._superModel){this._superModel.inheritRelations();if(this._superModel.prototype.relations){var e=t.select(this._superModel.prototype.relations||[],function(e){return!t.any(this.prototype.relations||[],function(t){return e.relatedModel===t.relatedModel&&e.key===t.key},this)},this);this.prototype.relations=e.concat(this.prototype.relations)}}else this._superModel=!1},findOrCreate:function(e,r){r||(r={});var i=t.isObject(e)&&r.parse&&this.prototype.parse?this.prototype.parse(t.clone(e)):e,s=n.Relational.store.find(this,i);return t.isObject(e)&&(s&&r.merge!==!1?(delete r.collection,delete r.url,s.set(i,r)):!s&&r.create!==!1&&(s=this.build(e,r))),s},find:function(e,t){return t||(t={}),t.create=!1,this.findOrCreate(e,t)}}),t.extend(n.RelationalModel.prototype,n.Semaphore),n.Collection.prototype.__prepareModel=n.Collection.prototype._prepareModel,n.Collection.prototype._prepareModel=function(e,t){var r;return e instanceof n.Model?(e.collection||(e.collection=this),r=e):(t||(t={}),t.collection=this,typeof this.model.findOrCreate!="undefined"?r=this.model.findOrCreate(e,t):r=new this.model(e,t),r&&r.isNew()&&!r._validate(e,t)&&(this.trigger("invalid",this,e,t),r=!1)),r};var i=n.Collection.prototype.__set=n.Collection.prototype.set;n.Collection.prototype.set=function(e,r){if(this.model.prototype instanceof n.RelationalModel){r&&r.parse&&(e=this.parse(e,r)),t.isArray(e)||(e=e?[e]:[]);var s=[],o=[];return t.each(e,function(e){e instanceof n.Model||(e=n.Collection.prototype._prepareModel.call(this,e,r)),e&&(o.push(e),!this.get(e)&&!this.get(e.cid)?s.push(e):e.id!=null&&(this._byId[e.id]=e))},this),i.call(this,o,t.defaults({parse:!1},r)),t.each(s,function(e){(this.get(e)||this.get(e.cid))&&this.trigger("relational:add",e,this,r)},this),this}return i.apply(this,arguments)};var s=n.Collection.prototype.__remove=n.Collection.prototype.remove;n.Collection.prototype.remove=function(e,r){if(this.model.prototype instanceof n.RelationalModel){e=t.isArray(e)?e.slice(0):[e],r||(r={});var i=[];return t.each(e,function(e){e=this.get(e)||e&&this.get(e.cid),e&&i.push(e)},this),i.length&&(s.call(this,i,r),t.each(i,function(e){this.trigger("relational:remove",e,this,r)},this)),this}return s.apply(this,arguments)};var o=n.Collection.prototype.__reset=n.Collection.prototype.reset;n.Collection.prototype.reset=function(e,r){return r=t.extend({merge:!0},r),o.call(this,e,r),this.model.prototype instanceof n.RelationalModel&&this.trigger("relational:reset",this,r),this};var u=n.Collection.prototype.__sort=n.Collection.prototype.sort;n.Collection.prototype.sort=function(e){return u.call(this,e),this.model.prototype instanceof n.RelationalModel&&this.trigger("relational:reset",this,e),this};var a=n.Collection.prototype.__trigger=n.Collection.prototype.trigger;n.Collection.prototype.trigger=function(e){if(this.model.prototype instanceof n.RelationalModel){if(e==="add"||e==="remove"||e==="reset"||e==="sort"){var r=this,i=arguments;t.isObject(i[3])&&(i=t.toArray(i),i[3]=t.clone(i[3])),n.Relational.eventQueue.add(function(){a.apply(r,i)})}else a.apply(this,arguments);return this}return a.apply(this,arguments)},n.RelationalModel.extend=function(e,t){var r=n.Model.extend.apply(this,arguments);return r.setup(this),r}})(),define("backbone-relational",["backbone"],function(){}),define("models/scope_item",["backbone","backbone-relational"],function(e,t){var n=e.RelationalModel.extend({});return n}),define("collections/scope_items",["backbone","models/scope_item"],function(e,t){var n=e.Collection.extend({model:t});return n}),define("models/status",["backbone","backbone-relational","moment"],function(e,t,n){var r=e.RelationalModel.extend({StatusCreated:"created",StatusSubmitted:"submitted",StatusAccepted:"accepted",StatusRejected:"rejected",StatusWaiting:"Waiting for Response",set:function(t,r,i){e.RelationalModel.prototype.set.apply(this,arguments),typeof t=="object"?_.has(t,"date")&&(this.attributes.date=n(t.date)):t==="date"&&(this.attributes.date=n(r))},url:function(){return this.get("paymentID")?"/agreement/v/"+this.get("agreementID")+"/payment/"+this.get("paymentID")+"/status":"/agreement/v/"+this.get("agreementID")+"/status"}});return r}),define("collections/status",["backbone","models/status"],function(e,t){var n=e.Collection.extend({model:t,comparator:function(e){return-e.get("date").valueOf()},filterByPaymentID:function(e){var t=this.filter(function(t){return t.get("paymentID")==e});return new n(t)},waiting:"waiting"});return n}),define("models/payment",["backbone","backbone-relational","models/scope_item","collections/scope_items","models/status","collections/status"],function(e,t,n,r,i,s){var o=e.RelationalModel.extend({relations:[{type:e.HasMany,key:"scopeItems",relatedModel:n,collectionType:r},{type:e.HasOne,key:"currentStatus",relatedModel:i,collectionType:s}],urlRoot:function(){return"/agreement/v/"+this.collection.parent.id+"/payment"},set:function(t,n,r){e.RelationalModel.prototype.set.apply(this,arguments),typeof t=="object"?(_.has(t,"amount")&&(this.attributes.amount=parseFloat(t.amount)),_.has(t,"dateExpected")&&(this.attributes.dateExpected=moment(t.dateExpected))):t==="amount"?this.attributes.amount=parseFloat(n):t==="dateExpected"&&(this.attributes.dateExpected=moment(n))},submit:function(e,t){this.updateStatus({action:"submitted",creditSourceURI:e},t)},accept:function(e){this.updateStatus({action:"accepted",debitSourceURI:e})},reject:function(e){this.updateStatus({action:"rejected",message:e})},updateStatus:function(e,t){$.ajax({type:"POST",url:"/agreement/v/"+this.collection.parent.id+"/payment/"+this.id+"/status",contentType:"application/json",dataType:"json",data:JSON.stringify(e),success:_.bind(function(e){this.collection.parent.set("currentStatus",e),this.set("currentStatus",this.collection.parent.get("currentStatus")),t()},this)})},isDeposit:function(){if(this.get("title")==="Deposit")return!0}});return o}),define("collections/payments",["backbone","models/payment"],function(e,t){var n=e.Collection.extend({model:t,getTotalAmount:function(){return this.reduce(function(e,t){return e+t.get("amount")},0)},findSubmittedPayment:function(){var e=this.filter(function(e){return e.get("currentStatus")&&e.get("currentStatus").get("action")==="submitted"});return e[0]},findFirstOutstandingPayment:function(){var e=this.filter(function(e){return!e.get("currentStatus")||e.get("currentStatus").get("action")!=="accepted"});return e[0]},findAllOutstandingPayment:function(){var e=this.filter(function(e){return!e.get("currentStatus")||e.get("currentStatus").get("action")!=="accepted"});return new n(e)},findFirstRequiredPayment:function(){var e=this.filter(function(e){return e.get("required")});return e.length==0?null:e[0]},getTotalPayments:function(){return this.length},getAcceptedPayments:function(){var e=this.filter(function(e){return e.get("currentStatus")!==null?e.get("currentStatus").get("action")==="accepted":0});return e.length},getNumberOfSubmittedPayments:function(){var e=this.filter(function(e){return e.get("currentStatus")&&e.get("currentStatus").get("action")==="submitted"});return e.length},getPercentComplete:function(){var e=this.getAcceptedPayments(),t=this.getTotalPayments();return e===0?0:e/t}});return n}),define("models/comment",["backbone","backbone-relational","moment"],function(e,t,n){var r=e.RelationalModel.extend({url:function(){return"/agreement/"+this.collection.agreement.get("agreementID")+"/comments"},set:function(t,r,i){e.RelationalModel.prototype.set.apply(this,arguments),typeof t=="object"?_.has(t,"dateCreated")&&(this.attributes.dateCreated=n(t.dateCreated)):t==="dateCreated"&&(this.attributes.dateCreated=n(r))}});return r}),define("collections/comments",["backbone","models/comment"],function(e,t){var n=e.Collection.extend({model:t,comparator:function(e){return-e.get("dateCreated").valueOf()}});return n}),define("models/agreement",["backbone","backbone-relational","models/payment","collections/payments","models/status","collections/status","models/comment","collections/comments"],function(e,t,n,r,i,s,o,u,a,f){var l=e.RelationalModel.extend({relations:[{type:e.HasMany,key:"payments",relatedModel:n,collectionType:r,reverseRelation:{key:"parent",includeInJSON:!1}},{type:e.HasMany,key:"statusHistory",relatedModel:i,collectionType:s,reverseRelation:{key:"ownerModel",includeInJSON:!1}},{type:e.HasOne,key:"currentStatus",relatedModel:i,reverseRelation:{includeInJSON:!1}},{type:e.HasMany,key:"comments",relatedModel:o,collectionType:u,includeInJSON:!1,reverseRelation:{key:"agreement",includeInJSON:!1}}],idAttribute:"versionID",urlRoot:function(){return"/agreement/v"},submit:function(e,t){this.updateStatus("submitted",e,t)},accept:function(e,t){this.updateStatus("accepted",e,t)},reject:function(e,t){this.updateStatus("rejected",e,t)},updateStatus:function(e,t,n){$.ajax({type:"POST",url:"/agreement/v/"+this.id+"/status",contentType:"application/json",dataType:"json",data:JSON.stringify({action:e,message:t,versionlessID:this.get("versionlessID")}),success:_.bind(function(e){this.set("currentStatus",e),_.isFunction(n)&&n()},this)})}});return l}),Backbone.ChildViewContainer=function(e,t){var n=function(e){this._views={},this._indexByModel={},this._indexByCustom={},this._updateLength(),t.each(e,this.add,this)};t.extend(n.prototype,{add:function(e,t){var n=e.cid;this._views[n]=e,e.model&&(this._indexByModel[e.model.cid]=n),t&&(this._indexByCustom[t]=n),this._updateLength()},findByModel:function(e){return this.findByModelCid(e.cid)},findByModelCid:function(e){var t=this._indexByModel[e];return this.findByCid(t)},findByCustom:function(e){var t=this._indexByCustom[e];return this.findByCid(t)},findByIndex:function(e){return t.values(this._views)[e]},findByCid:function(e){return this._views[e]},remove:function(e){var n=e.cid;e.model&&delete this._indexByModel[e.model.cid],t.any(this._indexByCustom,function(e,t){if(e===n)return delete this._indexByCustom[t],!0},this),delete this._views[n],this._updateLength()},call:function(e){this.apply(e,t.tail(arguments))},apply:function(e,n){t.each(this._views,function(r){t.isFunction(r[e])&&r[e].apply(r,n||[])})},_updateLength:function(){this.length=t.size(this._views)}});var r=["forEach","each","map","find","detect","filter","select","reject","every","all","some","any","include","contains","invoke","toArray","first","initial","rest","last","without","isEmpty","pluck"];return t.each(r,function(e){n.prototype[e]=function(){var n=t.values(this._views),r=[n].concat(t.toArray(arguments));return t[e].apply(t,r)}}),n}(Backbone,_),Backbone.Wreqr=function(e,t,n){var r={};return r.Handlers=function(e,t){var n=function(e){this.options=e,this._wreqrHandlers={},t.isFunction(this.initialize)&&this.initialize(e)};return n.extend=e.Model.extend,t.extend(n.prototype,e.Events,{setHandlers:function(e){t.each(e,function(e,n){var r=null;t.isObject(e)&&!t.isFunction(e)&&(r=e.context,e=e.callback),this.setHandler(n,e,r)},this)},setHandler:function(e,t,n){var r={callback:t,context:n};this._wreqrHandlers[e]=r,this.trigger("handler:add",e,t,n)},hasHandler:function(e){return!!this._wreqrHandlers[e]},getHandler:function(e){var t=this._wreqrHandlers[e];if(!t)throw new Error("Handler not found for '"+e+"'");return function(){var e=Array.prototype.slice.apply(arguments);return t.callback.apply(t.context,e)}},removeHandler:function(e){delete this._wreqrHandlers[e]},removeAllHandlers:function(){this._wreqrHandlers={}}}),n}(e,n),r.CommandStorage=function(){var t=function(e){this.options=e,this._commands={},n.isFunction(this.initialize)&&this.initialize(e)};return n.extend(t.prototype,e.Events,{getCommands:function(e){var t=this._commands[e];return t||(t={command:e,instances:[]},this._commands[e]=t),t},addCommand:function(e,t){var n=this.getCommands(e);n.instances.push(t)},clearCommands:function(e){var t=this.getCommands(e);t.instances=[]}}),t}(),r.Commands=function(e){return e.Handlers.extend({storageType:e.CommandStorage,constructor:function(t){this.options=t||{},this._initializeStorage(this.options),this.on("handler:add",this._executeCommands,this);var n=Array.prototype.slice.call(arguments);e.Handlers.prototype.constructor.apply(this,n)},execute:function(e,t){e=arguments[0],t=Array.prototype.slice.call(arguments,1),this.hasHandler(e)?this.getHandler(e).apply(this,t):this.storage.addCommand(e,t)},_executeCommands:function(e,t,r){var i=this.storage.getCommands(e);n.each(i.instances,function(e){t.apply(r,e)}),this.storage.clearCommands(e)},_initializeStorage:function(e){var t,r=e.storageType||this.storageType;n.isFunction(r)?t=new r:t=r,this.storage=t}})}(r),r.RequestResponse=function(e){return e.Handlers.extend({request:function(){var e=arguments[0],t=Array.prototype.slice.call(arguments,1);return this.getHandler(e).apply(this,t)}})}(r),r.EventAggregator=function(e,t){var n=function(){};return n.extend=e.Model.extend,t.extend(n.prototype,e.Events),n}(e,n),r}(Backbone,Backbone.Marionette,_);var Marionette=function(e,t,n){function s(e){return i.call(e)}function o(e,t){var n=new Error(e);throw n.name=t||"Error",n}var r={};t.Marionette=r,r.$=t.$;var i=Array.prototype.slice;return r.extend=t.Model.extend,r.getOption=function(e,t){if(!e||!t)return;var n;return e.options&&t in e.options&&e.options[t]!==undefined?n=e.options[t]:n=e[t],n},r.triggerMethod=function(){function t(e,t,n){return n.toUpperCase()}var e=/(^|:)(\w)/gi,r=function(r){var i="on"+r.replace(e,t),s=this[i];this.trigger.apply(this,arguments);if(n.isFunction(s))return s.apply(this,n.tail(arguments))};return r}(),r.MonitorDOMRefresh=function(){function e(e){e._isShown=!0,r(e)}function t(e){e._isRendered=!0,r(e)}function r(e){e._isShown&&e._isRendered&&n.isFunction(e.triggerMethod)&&e.triggerMethod("dom:refresh")}return function(n){n.listenTo(n,"show",function(){e(n)}),n.listenTo(n,"render",function(){t(n)})}}(),function(e){function t(e,t,r,i){var s=i.split(/\s+/);n.each(s,function(n){var i=e[n];i||o("Method '"+n+"' was configured as an event handler, but does not exist."),e.listenTo(t,r,i,e)})}function r(e,t,n,r){e.listenTo(t,n,r,e)}function i(e,t,r,i){var s=i.split(/\s+/);n.each(s,function(n){var i=e[n];e.stopListening(t,r,i,e)})}function s(e,t,n,r){e.stopListening(t,n,r,e)}function u(e,t,r,i,s){if(!t||!r)return;n.isFunction(r)&&(r=r.call(e)),n.each(r,function(r,o){n.isFunction(r)?i(e,t,o,r):s(e,t,o,r)})}e.bindEntityEvents=function(e,n,i){u(e,n,i,r,t)},e.unbindEntityEvents=function(e,t,n){u(e,t,n,s,i)}}(r),r.Callbacks=function(){this._deferred=r.$.Deferred(),this._callbacks=[]},n.extend(r.Callbacks.prototype,{add:function(e,t){this._callbacks.push({cb:e,ctx:t}),this._deferred.done(function(n,r){t&&(n=t),e.call(n,r)})},run:function(e,t){this._deferred.resolve(t,e)},reset:function(){var e=this._callbacks;this._deferred=r.$.Deferred(),this._callbacks=[],n.each(e,function(e){this.add(e.cb,e.ctx)},this)}}),r.Controller=function(e){this.triggerMethod=r.triggerMethod,this.options=e||{},n.isFunction(this.initialize)&&this.initialize(this.options)},r.Controller.extend=r.extend,n.extend(r.Controller.prototype,t.Events,{close:function(){this.stopListening(),this.triggerMethod("close"),this.unbind()}}),r.Region=function(e){this.options=e||{},this.el=r.getOption(this,"el");if(!this.el){var t=new Error("An 'el' must be specified for a region.");throw t.name="NoElError",t}if(this.initialize){var n=Array.prototype.slice.apply(arguments);this.initialize.apply(this,n)}},n.extend(r.Region,{buildRegion:function(e,t){var r=typeof e=="string",i=typeof e.selector=="string",s=typeof e.regionType=="undefined",o=typeof e=="function";if(!o&&!r&&!i)throw new Error("Region must be specified as a Region type, a selector string or an object with selector property");var u,a;r&&(u=e),e.selector&&(u=e.selector),o&&(a=e),!o&&s&&(a=t),e.regionType&&(a=e.regionType);var f=new a({el:u});return e.parentEl&&(f.getEl=function(t){var r=e.parentEl;return n.isFunction(r)&&(r=r()),r.find(t)}),f}}),n.extend(r.Region.prototype,t.Events,{show:function(e){this.ensureEl();var t=e.isClosed||n.isUndefined(e.$el),i=e!==this.currentView;i&&this.close(),e.render(),(i||t)&&this.open(e),this.currentView=e,r.triggerMethod.call(this,"show",e),r.triggerMethod.call(e,"show")},ensureEl:function(){if(!this.$el||this.$el.length===0)this.$el=this.getEl(this.el)},getEl:function(e){return r.$(e)},open:function(e){this.$el.empty().append(e.el)},close:function(){var e=this.currentView;if(!e||e.isClosed)return;e.close?e.close():e.remove&&e.remove(),r.triggerMethod.call(this,"close"),delete this.currentView},attachView:function(e){this.currentView=e},reset:function(){this.close(),delete this.$el}}),r.Region.extend=r.extend,r.RegionManager=function(e){var t=e.Controller.extend({constructor:function(t){this._regions={},e.Controller.prototype.constructor.call(this,t)},addRegions:function(e,t){var r={};return n.each(e,function(e,i){typeof e=="string"&&(e={selector:e}),e.selector&&(e=n.defaults({},e,t));var s=this.addRegion(i,e);r[i]=s},this),r},addRegion:function(t,r){var i,s=n.isObject(r),o=n.isString(r),u=!!r.selector;return o||s&&u?i=e.Region.buildRegion(r,e.Region):n.isFunction(r)?i=e.Region.buildRegion(r,e.Region):i=r,this._store(t,i),this.triggerMethod("region:add",t,i),i},get:function(e){return this._regions[e]},removeRegion:function(e){var t=this._regions[e];this._remove(e,t)},removeRegions:function(){n.each(this._regions,function(e,t){this._remove(t,e)},this)},closeRegions:function(){n.each(this._regions,function(e,t){e.close()},this)},close:function(){this.removeRegions();var t=Array.prototype.slice.call(arguments);e.Controller.prototype.close.apply(this,t)},_store:function(e,t){this._regions[e]=t,this._setLength()},_remove:function(e,t){t.close(),delete this._regions[e],this._setLength(),this.triggerMethod("region:remove",e,t)},_setLength:function(){this.length=n.size(this._regions)}}),r=["forEach","each","map","find","detect","filter","select","reject","every","all","some","any","include","contains","invoke","toArray","first","initial","rest","last","without","isEmpty","pluck"];return n.each(r,function(e){t.prototype[e]=function(){var t=n.values(this._regions),r=[t].concat(n.toArray(arguments));return n[e].apply(n,r)}}),t}(r),r.TemplateCache=function(e){this.templateId=e},n.extend(r.TemplateCache,{templateCaches:{},get:function(e){var t=this.templateCaches[e];return t||(t=new r.TemplateCache(e),this.templateCaches[e]=t),t.load()},clear:function(){var e,t=s(arguments),n=t.length;if(n>0)for(e=0;e<n;e++)delete this.templateCaches[t[e]];else this.templateCaches={}}}),n.extend(r.TemplateCache.prototype,{load:function(){if(this.compiledTemplate)return this.compiledTemplate;var e=this.loadTemplate(this.templateId);return this.compiledTemplate=this.compileTemplate(e),this.compiledTemplate},loadTemplate:function(e){var t=r.$(e).html();return(!t||t.length===0)&&o("Could not find template: '"+e+"'","NoTemplateError"),t},compileTemplate:function(e){return n.template(e)}}),r.Renderer={render:function(e,t){if(!e){var n=new Error("Cannot render the template since it's false, null or undefined.");throw n.name="TemplateNotFoundError",n}var i;return typeof e=="function"?i=e:i=r.TemplateCache.get(e),i(t)}},r.View=t.View.extend({constructor:function(){n.bindAll(this,"render");var e=Array.prototype.slice.apply(arguments);t.View.prototype.constructor.apply(this,e),r.MonitorDOMRefresh(this),this.listenTo(this,"show",this.onShowCalled,this)},triggerMethod:r.triggerMethod,getTemplate:function(){return r.getOption(this,"template")},mixinTemplateHelpers:function(e){e=e||{};var t=this.templateHelpers;return n.isFunction(t)&&(t=t.call(this)),n.extend(e,t)},configureTriggers:function(){if(!this.triggers)return;var e={},t=n.result(this,"triggers");return n.each(t,function(t,n){e[n]=function(e){e&&e.preventDefault&&e.preventDefault(),e&&e.stopPropagation&&e.stopPropagation();var n={view:this,model:this.model,collection:this.collection};this.triggerMethod(t,n)}},this),e},delegateEvents:function(e){this._delegateDOMEvents(e),r.bindEntityEvents(this,this.model,r.getOption(this,"modelEvents")),r.bindEntityEvents(this,this.collection,r.getOption(this,"collectionEvents"))},_delegateDOMEvents:function(e){e=e||this.events,n.isFunction(e)&&(e=e.call(this));var r={},i=this.configureTriggers();n.extend(r,e,i),t.View.prototype.delegateEvents.call(this,r)},undelegateEvents:function(){var e=Array.prototype.slice.call(arguments);t.View.prototype.undelegateEvents.apply(this,e),r.unbindEntityEvents(this,this.model,r.getOption(this,"modelEvents")),r.unbindEntityEvents(this,this.collection,r.getOption(this,"collectionEvents"))},onShowCalled:function(){},close:function(){if(this.isClosed)return;var e=this.triggerMethod("before:close");if(e===!1)return;this.isClosed=!0,this.triggerMethod("close"),this.unbindUIElements(),this.remove()},bindUIElements:function(){if(!this.ui)return;this._uiBindings||(this._uiBindings=this.ui);var e=n.result(this,"_uiBindings");this.ui={},n.each(n.keys(e),function(t){var n=e[t];this.ui[t]=this.$(n)},this)},unbindUIElements:function(){if(!this.ui)return;n.each(this.ui,function(e,t){delete this.ui[t]},this),this.ui=this._uiBindings,delete this._uiBindings}}),r.ItemView=r.View.extend({constructor:function(){r.View.prototype.constructor.apply(this,s(arguments))},serializeData:function(){var e={};return this.model?e=this.model.toJSON():this.collection&&(e={items:this.collection.toJSON()}),e},render:function(){this.isClosed=!1,this.triggerMethod("before:render",this),this.triggerMethod("item:before:render",this);var e=this.serializeData();e=this.mixinTemplateHelpers(e);var t=this.getTemplate(),n=r.Renderer.render(t,e);return this.$el.html(n),this.bindUIElements(),this.triggerMethod("render",this),this.triggerMethod("item:rendered",this),this},close:function(){if(this.isClosed)return;this.triggerMethod("item:before:close"),r.View.prototype.close.apply(this,s(arguments)),this.triggerMethod("item:closed")}}),r.CollectionView=r.View.extend({itemViewEventPrefix:"itemview",constructor:function(e){this._initChildViewStorage(),r.View.prototype.constructor.apply(this,s(arguments)),this._initialEvents()},_initialEvents:function(){this.collection&&(this.listenTo(this.collection,"add",this.addChildView,this),this.listenTo(this.collection,"remove",this.removeItemView,this),this.listenTo(this.collection,"reset",this.render,this))},addChildView:function(e,t,n){this.closeEmptyView();var r=this.getItemView(e),i=this.collection.indexOf(e);this.addItemView(e,r,i)},onShowCalled:function(){this.children.each(function(e){r.triggerMethod.call(e,"show")})},triggerBeforeRender:function(){this.triggerMethod("before:render",this),this.triggerMethod("collection:before:render",this)},triggerRendered:function(){this.triggerMethod("render",this),this.triggerMethod("collection:rendered",this)},render:function(){return this.isClosed=!1,this.triggerBeforeRender(),this._renderChildren(),this.triggerRendered(),this},_renderChildren:function(){this.closeEmptyView(),this.closeChildren(),this.collection&&this.collection.length>0?this.showCollection():this.showEmptyView()},showCollection:function(){var e;this.collection.each(function(t,n){e=this.getItemView(t),this.addItemView(t,e,n)},this)},showEmptyView:function(){var e=r.getOption(this,"emptyView");if(e&&!this._showingEmptyView){this._showingEmptyView=!0;var n=new t.Model;this.addItemView(n,e,0)}},closeEmptyView:function(){this._showingEmptyView&&(this.closeChildren(),delete this._showingEmptyView)},getItemView:function(e){var t=r.getOption(this,"itemView");return t||o("An `itemView` must be specified","NoItemViewError"),t},addItemView:function(e,t,i){var s=r.getOption(this,"itemViewOptions");n.isFunction(s)&&(s=s.call(this,e,i));var o=this.buildItemView(e,t,s);this.addChildViewEventForwarding(o),this.triggerMethod("before:item:added",o),this.children.add(o),this.renderItemView(o,i),this._isShown&&r.triggerMethod.call(o,"show"),this.triggerMethod("after:item:added",o)},addChildViewEventForwarding:function(e){var t=r.getOption(this,"itemViewEventPrefix");this.listenTo(e,"all",function(){var n=s(arguments);n[0]=t+":"+n[0],n.splice(1,0,e),r.triggerMethod.apply(this,n)},this)},renderItemView:function(e,t){e.render(),this.appendHtml(this,e,t)},buildItemView:function(e,t,r){var i=n.extend({model:e},r);return new t(i)},removeItemView:function(e){var t=this.children.findByModel(e);this.removeChildView(t),this.checkEmpty()},removeChildView:function(e){e&&(this.stopListening(e),e.close?e.close():e.remove&&e.remove(),this.children.remove(e)),this.triggerMethod("item:removed",e)},checkEmpty:function(){(!this.collection||this.collection.length===0)&&this.showEmptyView()},appendHtml:function(e,t,n){e.$el.append(t.el)},_initChildViewStorage:function(){this.children=new t.ChildViewContainer},close:function(){if(this.isClosed)return;this.triggerMethod("collection:before:close"),this.closeChildren(),this.triggerMethod("collection:closed"),r.View.prototype.close.apply(this,s(arguments))},closeChildren:function(){this.children.each(function(e){this.removeChildView(e)},this),this.checkEmpty()}}),r.CompositeView=r.CollectionView.extend({constructor:function(){r.CollectionView.prototype.constructor.apply(this,s(arguments))},_initialEvents:function(){this.collection&&(this.listenTo(this.collection,"add",this.addChildView,this),this.listenTo(this.collection,"remove",this.removeItemView,this),this.listenTo(this.collection,"reset",this._renderChildren,this))},getItemView:function(e){var t=r.getOption(this,"itemView")||this.constructor;return t||o("An `itemView` must be specified","NoItemViewError"),t},serializeData:function(){var e={};return this.model&&(e=this.model.toJSON()),e},render:function(){this.isRendered=!0,this.isClosed=!1,this.resetItemViewContainer(),this.triggerBeforeRender();var e=this.renderModel();return this.$el.html(e),this.bindUIElements(),this.triggerMethod("composite:model:rendered"),this._renderChildren(),this.triggerMethod("composite:rendered"),this.triggerRendered(),this},_renderChildren:function(){this.isRendered&&(r.CollectionView.prototype._renderChildren.call(this),this.triggerMethod("composite:collection:rendered"))},renderModel:function(){var e={};e=this.serializeData(),e=this.mixinTemplateHelpers(e);var t=this.getTemplate();return r.Renderer.render(t,e)},appendHtml:function(e,t,n){var r=this.getItemViewContainer(e);r.append(t.el)},getItemViewContainer:function(e){if("$itemViewContainer"in e)return e.$itemViewContainer;var t;if(e.itemViewContainer){var r=n.result(e,"itemViewContainer");t=e.$(r),t.length<=0&&o("The specified `itemViewContainer` was not found: "+e.itemViewContainer,"ItemViewContainerMissingError")}else t=e.$el;return e.$itemViewContainer=t,t},resetItemViewContainer:function(){this.$itemViewContainer&&delete this.$itemViewContainer}}),r.Layout=r.ItemView.extend({regionType:r.Region,constructor:function(e){e=e||{},this._firstRender=!0,this._initializeRegions(e),r.ItemView.prototype.constructor.call(this,e)},render:function(){this._firstRender?this._firstRender=!1:this.isClosed?this._initializeRegions():this._reInitializeRegions();var e=Array.prototype.slice.apply(arguments),t=r.ItemView.prototype.render.apply(this,e);return t},close:function(){if(this.isClosed)return;this.regionManager.close();var e=Array.prototype.slice.apply(arguments);r.ItemView.prototype.close.apply(this,e)},addRegion:function(e,t){var n={};return n[e]=t,this.addRegions(n)[e]},addRegions:function(e){return this.regions=n.extend(this.regions||{},e),this._buildRegions(e)},removeRegion:function(e){return this.regionManager.removeRegion(e)},_buildRegions:function(e){var t=this,n={parentEl:function(){return t.$el}};return this.regionManager.addRegions(e,n)},_initializeRegions:function(e){var t;this._initRegionManager(),n.isFunction(this.regions)?t=this.regions(e):t=this.regions||{},this.addRegions(t)},_reInitializeRegions:function(){this.regionManager.closeRegions(),this.regionManager.each(function(e){e.reset()})},_initRegionManager:function(){this.regionManager=new r.RegionManager,this.listenTo(this.regionManager,"region:add",function(e,t){this[e]=t,this.trigger("region:add",e,t)}),this.listenTo(this.regionManager,"region:remove",function(e,t){delete this[e],this.trigger("region:remove",e,t)})}}),r.AppRouter=t.Router.extend({constructor:function(e){t.Router.prototype.constructor.apply(this,s(arguments)),this.options=e;if(this.appRoutes){var n=r.getOption(this,"controller");this.processAppRoutes(n,this.appRoutes)}},processAppRoutes:function(e,t){var r=n.keys(t).reverse();n.each(r,function(r){var i=t[r],s=e[i];if(!s)throw new Error("Method '"+i+"' was not found on the controller");this.route(r,i,n.bind(s,e))},this)}}),r.Application=function(e){this._initRegionManager(),this._initCallbacks=new r.Callbacks,this.vent=new t.Wreqr.EventAggregator,this.commands=new t.Wreqr.Commands,this.reqres=new t.Wreqr.RequestResponse,this.submodules={},n.extend(this,e),this.triggerMethod=r.triggerMethod},n.extend(r.Application.prototype,t.Events,{execute:function(){var e=Array.prototype.slice.apply(arguments);this.commands.execute.apply(this.commands,e)},request:function(){var e=Array.prototype.slice.apply(arguments);return this.reqres.request.apply(this.reqres,e)},addInitializer:function(e){this._initCallbacks.add(e)},start:function(e){this.triggerMethod("initialize:before",e),this._initCallbacks.run(e,this),this.triggerMethod("initialize:after",e),this.triggerMethod("start",e)},addRegions:function(e){return this._regionManager.addRegions(e)},removeRegion:function(e){this._regionManager.removeRegion(e)},module:function(e,t){var n=s(arguments);return n.unshift(this),r.Module.create.apply(r.Module,n)},_initRegionManager:function(){this._regionManager=new r.RegionManager,this.listenTo(this._regionManager,"region:add",function(e,t){this[e]=t}),this.listenTo(this._regionManager,"region:remove",function(e,t){delete this[e]})}}),r.Application.extend=r.extend,r.Module=function(e,t){this.moduleName=e,this.submodules={},this._setupInitializersAndFinalizers(),this.app=t,this.startWithParent=!0,this.triggerMethod=r.triggerMethod},n.extend(r.Module.prototype,t.Events,{addInitializer:function(e){this._initializerCallbacks.add(e)},addFinalizer:function(e){this._finalizerCallbacks.add(e)},start:function(e){if(this._isInitialized)return;n.each(this.submodules,function(t){t.startWithParent&&t.start(e)}),this.triggerMethod("before:start",e),this._initializerCallbacks.run(e,this),this._isInitialized=!0,this.triggerMethod("start",e)},stop:function(){if(!this._isInitialized)return;this._isInitialized=!1,r.triggerMethod.call(this,"before:stop"),n.each(this.submodules,function(e){e.stop()}),this._finalizerCallbacks.run(undefined,this),this._initializerCallbacks.reset(),this._finalizerCallbacks.reset(),r.triggerMethod.call(this,"stop")},addDefinition:function(e,t){this._runModuleDefinition(e,t)},_runModuleDefinition:function(e,i){if(!e)return;var s=n.flatten([this,this.app,t,r,r.$,n,i]);e.apply(this,s)},_setupInitializersAndFinalizers:function(){this._initializerCallbacks=new r.Callbacks,this._finalizerCallbacks=new r.Callbacks}}),n.extend(r.Module,{create:function(e,t,r){var i=e,o=s(arguments);o.splice(0,3),t=t.split(".");var u=t.length,a=[];return a[u-1]=r,n.each(t,function(t,n){var r=i;i=this._getModule(r,t,e),this._addModuleDefinition(r,i,a[n],o)},this),i},_getModule:function(e,t,n,i,s){var o=e[t];return o||(o=new r.Module(t,n),e[t]=o,e.submodules[t]=o),o},_addModuleDefinition:function(e,t,r,i){var s,o;n.isFunction(r)?(s=r,o=!0):n.isObject(r)?(s=r.define,o=r.startWithParent):o=!0,s&&t.addDefinition(s,i),t.startWithParent=t.startWithParent&&o,t.startWithParent&&!t.startWithParentIsConfigured&&(t.startWithParentIsConfigured=!0,e.addInitializer(function(e){t.startWithParent&&t.start(e)}))}}),r}(this,Backbone,_);define("marionette",["jquery","underscore","backbone"],function(e){return function(){var t,n;return t||e.Marionette}}(this)),define("text!templates/agreement/layout_tpl.html",[],function(){return'  <div id="header-section"></div>\n  <div id="agreement-profile" class="data-table agreement_profile_container"></div>\n  <div class="divider"></div>\n  <div id="notification_container" class="notification_container agreement_notification hide"><p class="notification_text bank_account_saved"><i class="fa fa-check"></i><p></div>\n  <div id="notifications"></div>\n  <div id="agreement-progress-bar"></div>\n  <div id="payment-schedule" class="clear"></div>\n  <div class="divider"></div>\n\n  <div id="proposed-services" class="column-full">\n  	<h2 class="agreement_title">Agreement Overview</h2>\n  	<p>{{proposedServices}}</p>\n  </div>\n\n  <div class="divider"></div>\n\n  \n  <div id="discussion" class="clear">\n  </div>\n\n  <div id="popup_container"></div>\n      \n      <div class="payment"></div>\n    </div>\n\n  </div>\n  \n  <div class="clear agreement_history">\n   <div id="agreement-history"></div>\n </div>\n <div class="clear">\n  <p class="void_agreement">\n    If, for whatever reason, you feel this agreement is no longer valid, you can <a href="void.html">void the agreement</a>.\n  </p>\n</div>\n'}),define("views/agreement/layout_manager",["backbone","handlebars","underscore","marionette","text!templates/agreement/layout_tpl.html"],function(e,t,n,r,i){var s=e.Marionette.Layout.extend({el:"#content",template:t.compile(i),regions:{profile:"#agreement-profile",agreementProgressBar:"#agreement-progress-bar",paymentSchedule:"#payment-schedule",agreementHistory:"#agreement-history",header:"#header-section",discussion:"#discussion"},initialize:function(){this.render()}});return s}),define("text!templates/agreement/payment_read_tpl.html",[],function(){return'<h2 class="agreement_title">Payment Schedule <span id="payments-total"><span></h2>\n\n<ul class="payment_milestone_container"></ul>'}),define("text!templates/agreement/payment_item_tpl.html",[],function(){return'<li class="payment_milestone">\n	<strong>${{amount}}</strong> &mdash; {{title}}\n\n	{{#unless required}}\n	{{#if dateExpected}} on {{dateFormat dateExpected}}{{/if}}\n	{{/unless}}\n	<div class="paymentStatus payment_status"></div>\n</li>\n	\n<ul class="scope_items_container"></ul>\n'}),define("text!templates/agreement/scope_item_tpl.html",[],function(){return'<li class="scope_item">{{text}}</li>'}),define("views/agreement/scope_item_view",["backbone","handlebars","text!templates/agreement/scope_item_tpl.html"],function(e,t,n){var r=e.View.extend({template:t.compile(n),render:function(){return this.$el.html(this.template(this.model.toJSON())),this}});return r}),define("views/agreement/payment_item_view",["backbone","handlebars","underscore","marionette","text!templates/agreement/payment_item_tpl.html","views/agreement/scope_item_view"],function(e,t,n,r,i,s){t.registerHelper("dateFormat",function(e){return e.format("MMM D, YYYY")});var o=e.Marionette.CompositeView.extend({template:t.compile(i),itemView:s,itemViewContainer:".scope_items_container",initialize:function(e){this.collection=this.model.get("scopeItems"),this.userIsClient=e.userIsClient,this.listenTo(this.model,"change",this.checkStatus)},onRender:function(){this.checkStatus()},checkStatus:function(){var e=this.model.get("currentStatus");if(!e)return;switch(e.get("action")){case e.StatusSubmitted:this.submittedState();break;case e.StatusAccepted:this.acceptedState();break;default:}},submittedState:function(){this.$(".paymentStatus").html('<span class="payment_status">Payment Pending</span>')},acceptedState:function(){this.$(".paymentStatus").html('<span class="payment_status">Payment Made</span>')}});return o}),define("views/agreement/payments_read_view",["backbone","handlebars","underscore","marionette","text!templates/agreement/payment_read_tpl.html","views/agreement/payment_item_view"],function(e,t,n,r,i,s){var o=e.Marionette.CompositeView.extend({template:t.compile(i),itemView:s,itemViewContainer:"ul",initialize:function(){this.collection=this.model.get("payments")},onRender:function(){this.$("#payments-total").text("$"+this.collection.getTotalAmount())},updateState:function(){var e=this.model.get("currentStatus")}});return o}),define("text!templates/agreement/agreement_history_tpl.html",[],function(){return'<h2 class="agreement_history_title">Agreement History</h2>\n'}),define("text!templates/agreement/status_item_tpl.html",[],function(){return'{{action}} on {{date}}\n<div class="comments-container"></div>\n'}),define("text!templates/agreement/comment_tpl.html",[],function(){return'<div>\n	{{#if isThisUserMessage}}\n		<div class="personal_box float_right">\n			<div class="message_photo_container">\n				<img class="message_photo" width="100" src="{{thisAvatar}}">\n			</div>\n			<div class="comment_post_info">\n				<div class="comment_name">{{name}}</div>\n				<div class="comment_date">{{dateCreated}}</div>\n			</div>\n		</div>\n		<div class="message_box float_right">\n			<div class="notification_container message_notification_container hide"><p class="notification_text"><i class="fa fa-check"></i> Message sent!<p></div>\n			<div class="tag_container">\n				<div class="milestone_tag">{{milestoneTitle}}</div>\n				<div class="status_tag">{{statusTitle}}</div>\n			</div>\n			<p class="comment_body">{{model.text}}</p>\n		</div>\n	{{else}}\n		<div class="personal_box float_left">\n			<div class="message_photo_container"><img class="message_photo" width="100" src="{{otherAvatar}}"></div>\n			<div class="comment_post_info">\n				<div class="comment_name">{{otherName}}</div>\n				<div class="comment_date">{{dateCreated}}</div>\n			</div>\n		</div>\n		<div class="message_box float_left">\n			<div class="notification_container message_notification_container hide"><p class="notification_text"><i class="fa fa-check"></i> Message sent!<p></div>\n			<div class="tag_container">\n				<div class="milestone_tag">{{milestoneTitle}}</div>\n				<div class="status_tag">{{statusTitle}}</div>\n			</div>\n			<p class="comment_body">{{model.text}}</p>\n		</div>\n	{{/if}}\n \n\n</div>'}),define("views/agreement/comment_view",["backbone","handlebars","text!templates/agreement/comment_tpl.html"],function(e,t,n){var r=e.View.extend({template:t.compile(n),className:"hide comment_container",initialize:function(e){this.agreement=e.agreement,this.avatar=e.user.get("avatarURL"),this.milestone=this.agreement.get("payments").get(this.model.get("milestoneID")),this.status=this.agreement.get("statusHistory").get(this.model.get("statusID")),this.commentCreatedDate=this.model.get("dateCreated"),this.firstName=e.user.get("firstName"),this.lastName=e.user.get("lastName"),this.userID=e.user.get("id"),this.messageUserID=this.model.get("userID"),this.email=e.user.get("email"),this.otherUserFirstName=e.otherUser.get("firstName"),this.otherUserLastName=e.otherUser.get("lastName"),this.otherUserEmail=e.otherUser.get("email"),this.otherAvatar=e.otherUser.get("avatarURL")},render:function(){var e,t,n,r,i,s,o,u,a;if(this.status){var f=this.status.get("paymentID")?"Payment":"Agreement";e=f+" "+this.status.get("action")+" on "+this.status.get("date").format("MMM D, YYYY")}if($(".discussion_placeholder")){var l=$(".discussion_placeholder");l.remove()}this.commentCreatedDate&&(t=this.commentCreatedDate.format("h:mm a"));var o=this.userID===this.messageUserID;this.firstName||this.lastName?s=this.firstName+" "+this.lastName:s=this.otherUserEmail,this.avatar?n=this.avatar:n="/img/default_photo.jpg",this.otherAvatar?a=this.otherAvatar:a="/img/default_photo.jpg",this.otherUserFirstName||this.otherUserLastName?u=this.otherUserFirstName+" "+this.otherUserLastName:u=this.email;var c=this.milestone?this.milestone.get("title"):"";return this.$el.html(this.template({model:this.model.toJSON(),milestoneTitle:c,statusTitle:e,dateCreated:t,thisAvatar:n,name:s,isThisUserMessage:o,otherName:u,otherAvatar:a})),this.fadeIn(this.$el),this},fadeIn:function(e){_.defer(function(){e.fadeIn()})}});return r}),define("views/agreement/status_view",["backbone","handlebars","underscore","marionette","moment","text!templates/agreement/status_item_tpl.html","views/agreement/comment_view"],function(e,t,n,r,i,s,o){var u=e.Marionette.CompositeView.extend({template:t.compile(s),tagName:"li",className:"agreement_history_items",itemView:o,itemViewContainer:".comments-container",events:{"keypress input":"addComment"},initialize:function(){this.collection=this.model.get("comments")},addComment:function(e){if(e.keyCode==13){var t=new this.collection.model({text:e.target.value,dateCreated:i(),authorID:window.thisUser.id});this.collection.add(t),this.model.save(),e.target.value=null}}});return u}),define("views/agreement/agreement_history_view",["backbone","handlebars","underscore","marionette","text!templates/agreement/agreement_history_tpl.html","views/agreement/status_view"],function(e,t,n,r,i,s){var o=e.Marionette.CompositeView.extend({tagName:"ul",className:"agreement_history_items_container",template:t.compile(i),itemView:s,initialize:function(){this.collection=this.model.get("statusHistory");var e=this.model.get("statusHistory").models}});return o}),define("text!templates/agreement/user_tpl.html",[],function(){return'<table border="0" cellspacing="0" cellpadding="0">\n	{{#if this}}\n  <tr>\n    <td class="meta">\n      <span><img src="{{avatarURL}}"></span>\n    </td>\n    <td>\n      <h3><a href="detail.html">{{firstName}} {{lastName}}</a></h3>\n      <p>{{email}} {{#if phoneNumber}}&mdash; {{phoneNumber}}{{/if}}</p>\n    </td>\n  </tr>\n  {{else}}\n  Has not been sent to client yet\n  {{/if}}\n</table>'}),define("views/agreement/user_view",["backbone","handlebars","text!templates/agreement/user_tpl.html"],function(e,t,n){var r=e.View.extend({template:t.compile(n),render:function(){return this.$el.html(this.template(window.otherUser)),this}});return r}),define("text!templates/agreement/edit/user_tpl.html",[],function(){return'{{#if this}}\n<table border="0" cellspacing="0" cellpadding="0">\n  <tr>\n    <td class="meta">\n      <span><img src="{{avatarURL}}"></span>\n    </td>\n    <td>\n      <h3><a href="detail.html">{{firstName}} {{lastName}}</a></h3>\n      <p>{{email}} {{#if phoneNumber}}&mdash; {{phoneNumber}}{{/if}}</p>\n    </td>\n  </tr>\n</table>\n{{else}}\n  <h2 class="edit_recipient">Recipient</h2>\n  <input class="edit_email_input" name="clientEmail" placeholder="Recipient E-mail Address"></input>\n  {{/if}}\n'}),define("views/agreement/edit/user_edit_view",["backbone","handlebars","text!templates/agreement/edit/user_tpl.html"],function(e,t,n){var r=e.View.extend({template:t.compile(n),render:function(){return this.$el.html(this.template(window.otherUser)),this},events:{"blur input":"updateFields"},updateFields:function(e){this.model.set(e.target.name,e.target.value),console.log(this.model)}});return r}),define("text!templates/agreement/edit/header_edit_tpl.html",[],function(){return'<div id="intro" class="clear intro">\n	<div class="column-three-fourth">\n		<h1>{{model.title}}</h1>\n	</div>\n	<div class="column-one-fourth">\n		<ul class="action_button_container">\n			{{#if button2Title}}<li><a id="action-button2" class="button action_button">{{button2Title}}</a></li>{{/if}}\n		</ul>\n	</div>\n</div>\n<div id="popup_container"></div>'}),define("views/agreement/edit/header_edit_view",["backbone","handlebars","text!templates/agreement/edit/header_edit_tpl.html"],function(e,t,n){var r=e.View.extend({template:t.compile(n),render:function(){return this.$el.html(this.template({model:this.model.toJSON(),button2Title:"Save Draft"})),this},events:{"click #action-button2":"save"},save:function(){this.model.get("draft")||this.model.unset("versionID"),this.model.set("draft",!0),console.log(this.model),this.model.save({},{success:function(e,t){}})}});return r}),define("text!templates/agreement/edit/payment_edit_tpl.html",[],function(){return'<h2 class="agreement_title">Payment Schedule<span id="payments-total"><span></h2>\n\n<ul class="work_item_container"></ul>\n  <fieldset id="addMoreButton" class="addMoreButton">\n    <p style="margin-left:20px;" class="add-more">\n    	<a>Add Another Payment Milestone</a>\n    </p>\n  </fieldset>'}),function(){var e,t,n=function(e,n){if("function"==typeof document.addEventListener||i.isIE8()){var o=!1;try{o=e instanceof Element}catch(u){o=!!e&&1===o.nodeType}o||"string"==typeof e||(n=e);var a=this,f=a.classes,l=a.settings=i.merge(a.defaults,{attachTo:e},n||{}),o=a.container=i.make("div",{"class":f.container}),h=a.calendars=[],p=t().day(l.weekStart),d,v=[],m,g,y;m=[];var b;g=0,d=l.months,i.isIE8()&&i.addClassName(o,"ie8");for(g=7;g--;)v.push(p.format(l.columnHeaderFormat)),p.add("days",1);s(a);if("object"==typeof l.subscribe)for(g in l.subscribe)l.subscribe.hasOwnProperty(g)&&a.subscribe(g,l.subscribe[g]);a._sel=[],l.selected&&a.setSelected(l.selected,!1),d=l.viewStartDate?t(l.viewStartDate,l.format):0<a._sel.length?t(a._sel[0]):t(),a.viewStartDate=d.date(1),(d={past:l.months-1,"today-past":l.months-1,any:2<l.months?Math.floor(l.months/2):0,"today-future":0,future:0}[this.settings.direction])&&t().month()==t(a.viewStartDate).month()&&(a.viewStartDate=t(a.viewStartDate).subtract({M:d}).date(1));if("function"==typeof l.blackout)a.blackout=l.blackout;else if(l.blackout){var E=r(l.blackout,l.parseSplitDelimiter,l.format);a.blackout=function(e){e=t(e).yearDay();if(1>e||!a._sel)return!1;for(var n=E.length;n--;)if(E[n].yearDay()===e)return!0;return!1}}else a.blackout=function(){return!1};a.direction=a.directions[l.direction]?a.directions[l.direction]:a.directions.any;for(d=Math.max(l.months,1);d--;){m=i.make("div",{"class":f.calendar},o),m.setAttribute("data-cal-index",d),1<l.months&&(d==Math.max(l.months-1,1)?i.addClassName(m,f.monthFirst):0===d?i.addClassName(m,f.monthLast):i.addClassName(m,f.monthMiddle)),g=i.make("div",{"class":f.title},m),l.useYearNav||i.addClassName(g,f.disableYearNav),i.make("a",{"class":f.previousYear},g),i.make("a",{"class":f.previousMonth},g),i.make("a",{"class":f.nextYear},g),i.make("a",{"class":f.nextMonth},g),p=i.make("span",{"class":f.caption},g),y=i.make("div",{"class":f.header},m),g=0;do b=i.make("span",{},y),b.innerHTML=v[g];while(7>++g);y=i.make("div",{"class":f.days},m),g=0;for(m=[];42>g++;)m.push(i.make("span",{},y));h.push({caption:p,days:m}),d&&i.make("div",{"class":f.monthSeparator},o)}a.draw(),i.addEvent(o,"mousedown",function(e,n){var r;if(i.hasClassName(n,f.nextMonth))!a.disableNext&&!1!==a.publish("view-changed",a,["next-month"])&&(a.viewStartDate.add("months",1),a.draw());else if(i.hasClassName(n,f.previousMonth))!a.disablePreviousMonth&&!1!==a.publish("view-changed",a,["previous-month"])&&(a.viewStartDate.subtract("months",1),a.draw());else if(i.hasClassName(n,f.nextYear))!a.disableNext&&!1!==a.publish("view-changed",a,["next-year"])&&(a.viewStartDate.add("years",1),a.draw());else if(i.hasClassName(n,f.previousYear))!a.disablePreviousMonth&&!1!==a.publish("view-changed",a,["previous-year"])&&(a.viewStartDate.subtract("years",1),a.draw());else if(i.hasClassName(n.parentNode,f.days)&&i.hasClassName(n,f.dayActive)&&(r=n.getAttribute("data-date")))if(r=t(r,l.dayAttributeFormat).hours(12),!1!==a.publish("date-clicked",a,[r]))switch(l.mode){case"multiple":a.addSelected(r)||a.removeSelected(r);break;case"range":a.addSelected(r);break;default:a.addSelected(r)}return!1}),(l.attachTo=i.$(l.attachTo))&&l.attachTo.appendChild(o)}};n.prototype={defaults:{attachTo:null,months:1,weekStart:0,direction:"any",directionScrolling:!0,viewStartDate:null,blackout:null,selected:null,mode:"single",dayOutOfMonthClickable:!1,format:null,subscribe:null,columnHeaderFormat:"dd",titleFormat:"MMMM, YYYY",dayNumberFormat:"D",dayAttributeFormat:"YYYY-MM-DD",parseSplitDelimiter:/,\s*|\s+-\s+/,rangeDelimiter:" - ",multipleDelimiter:", ",useYearNav:!0,dateClassMap:{}},classes:{container:"kalendae",calendar:"k-calendar",monthFirst:"k-first-month",monthMiddle:"k-middle-month",monthLast:"k-last-month",title:"k-title",previousMonth:"k-btn-previous-month",nextMonth:"k-btn-next-month",previousYear:"k-btn-previous-year",nextYear:"k-btn-next-year",caption:"k-caption",header:"k-header",days:"k-days",dayOutOfMonth:"k-out-of-month",dayInMonth:"k-in-month",dayActive:"k-active",daySelected:"k-selected",dayInRange:"k-range",dayToday:"k-today",monthSeparator:"k-separator",disablePreviousMonth:"k-disable-previous-month-btn",disableNextMonth:"k-disable-next-month-btn",disablePreviousYear:"k-disable-previous-year-btn",disableNextYear:"k-disable-next-year-btn",disableYearNav:"k-disable-year-nav"},disablePreviousMonth:!1,disableNextMonth:!1,disablePreviousYear:!1,disableNextYear:!1,directions:{past:function(n){return t(n).yearDay()>=e.yearDay()},"today-past":function(n){return t(n).yearDay()>e.yearDay()},any:function(){return!1},"today-future":function(n){return t(n).yearDay()<e.yearDay()},future:function(n){return t(n).yearDay()<=e.yearDay()}},getSelectedAsDates:function(){for(var e=[],t=0,n=this._sel.length;t<n;t++)e.push(this._sel[t].toDate());return e},getSelectedAsText:function(e){for(var t=[],n=0,r=this._sel.length;n<r;n++)t.push(this._sel[n].format(e||this.settings.format||"YYYY-MM-DD"));return t},getSelectedRaw:function(){for(var e=[],n=0,r=this._sel.length;n<r;n++)e.push(t(this._sel[n]));return e},getSelected:function(e){e=this.getSelectedAsText(e);switch(this.settings.mode){case"range":return e.splice(2),e.join(this.settings.rangeDelimiter);case"multiple":return e.join(this.settings.multipleDelimiter);default:return e[0]}},isSelected:function(e){e=t(e).yearDay();if(1>e||!this._sel||1>this._sel.length)return!1;switch(this.settings.mode){case"range":var n=this._sel[0]?this._sel[0].yearDay():0,r=this._sel[1]?this._sel[1].yearDay():0;return n===e||r===e?1:!n||!r?0:e>n&&e<r||n<r&&e<n&&e>r?-1:!1;case"multiple":for(n=this._sel.length;n--;)if(this._sel[n].yearDay()===e)return!0;return!1;default:return this._sel[0]&&this._sel[0].yearDay()===e}},setSelected:function(e,t){var n,i=r(e,this.settings.parseSplitDelimiter,this.settings.format),s=r(this.getSelected(),this.settings.parseSplitDelimiter,this.settings.format);for(n=s.length;n--;)this.removeSelected(s[n],t);for(n=i.length;n--;)this.addSelected(i[n],t);!1!==t&&this.draw()},addSelected:function(e,n){e=t(e,this.settings.format).hours(12),this.settings.dayOutOfMonthClickable&&"range"!==this.settings.mode&&this.makeSelectedDateVisible(e);switch(this.settings.mode){case"multiple":if(this.isSelected(e))return!1;this._sel.push(e);break;case"range":1!==this._sel.length?this._sel=[e]:e.yearDay()>this._sel[0].yearDay()?this._sel[1]=e:this._sel=[e,this._sel[0]];break;default:this._sel=[e]}return this._sel.sort(function(e,t){return e.yearDay()-t.yearDay()}),this.publish("change",this,[e]),!1!==n&&this.draw(),!0},makeSelectedDateVisible:function(e){outOfViewMonth=t(e).date("1").diff(this.viewStartDate,"months"),0>outOfViewMonth?this.viewStartDate.subtract("months",1):0<outOfViewMonth&&outOfViewMonth>=this.settings.months&&this.viewStartDate.add("months",1)},removeSelected:function(e,n){e=t(e,this.settings.format).hours(12);for(var r=this._sel.length;r--;)if(this._sel[r].yearDay()===e.yearDay())return this._sel.splice(r,1),this.publish("change",this,[e]),!1!==n&&this.draw(),!0;return!1},draw:function(){var n=t(this.viewStartDate).hours(12),r,s=this.classes,o,u,a,f=0,l,h=0,p,d=this.settings;l=this.calendars.length;do{r=t(n).date(1),r.day(r.day()<this.settings.weekStart?this.settings.weekStart-7:this.settings.weekStart),o=this.calendars[f],o.caption.innerHTML=n.format(this.settings.titleFormat),h=0;do u=o.days[h],a=[],(p=this.isSelected(r))&&a.push({"-1":s.dayInRange,1:s.daySelected,"true":s.daySelected}[p]),r.month()!=n.month()?a.push(s.dayOutOfMonth):a.push(s.dayInMonth),(!this.blackout(r)&&!(this.direction(r)||r.month()!=n.month()&&!1===d.dayOutOfMonthClickable)||0<p)&&a.push(s.dayActive),r.yearDay()===e.yearDay()&&a.push(s.dayToday),p=r.format(this.settings.dayAttributeFormat),d.dateClassMap[p]&&a.push(d.dateClassMap[p]),u.innerHTML=r.format(d.dayNumberFormat),u.className=a.join(" "),u.setAttribute("data-date",p),r.add("days",1);while(42>++h);n.add("months",1)}while(++f<l);if(d.directionScrolling){if("today-past"===d.direction||"past"===d.direction)r=n.add({m:1}).diff(t(),"months",!0),0>=r?(this.disableNextMonth=!1,i.removeClassName(this.container,s.disableNextMonth)):(this.disableNextMonth=!0,i.addClassName(this.container,s.disableNextMonth));else if("today-future"===d.direction||"future"===d.direction)r=n.subtract({m:1}).diff(t(),"months",!0),r>d.months?(this.disablePreviousMonth=!1,i.removeClassName(this.container,s.disablePreviousMonth)):(this.disablePreviousMonth=!0,i.addClassName(this.container,s.disablePreviousMonth));if("today-past"===d.direction||"past"===d.direction)r=n.add({m:12}).diff(t(),"months",!0),-11>=r?(this.disableNextYear=!1,i.removeClassName(this.container,s.disableNextYear)):(this.disableNextYear=!0,i.addClassName(this.container,s.disableNextYear));else if("today-future"===d.direction||"future"===d.direction)r=n.subtract({m:12}).diff(t(),"months",!0),r>11+d.months?(this.disablePreviousYear=!1,i.removeClassName(this.container,s.disablePreviousYear)):(this.disablePreviousYear=!0,i.addClassName(this.container,s.disablePreviousYear))}}};var r=function(e,n,r){var s=[];"string"==typeof e?e=e.split(n):i.isArray(e)||(e=[e]),n=e.length;var o=0;do e[o]&&s.push(t(e[o],r).hours(12));while(++o<n);return s};window.Kalendae=n;var i=n.util={isIE8:function(){return!(!/msie 8./i.test(navigator.appVersion)||/opera/i.test(navigator.userAgent)||!window.ActiveXObject||!XDomainRequest||window.msPerformance)},$:function(e){return"string"==typeof e?document.getElementById(e):e},$$:function(e){return document.querySelectorAll(e)},make:function(e,t,n){var r;e=document.createElement(e);if(t)for(r in t)t.hasOwnProperty(r)&&e.setAttribute(r,t[r]);return n&&n.appendChild(e),e},isVisible:function(e){return 0<e.offsetWidth||0<e.offsetHeight},getStyle:function(e,t){var n;return e.currentStyle?n=e.currentStyle[t]:window.getComputedStyle&&(n=window.getComputedStyle(e,null)[t]),n},domReady:function(e){/in/.test(document.readyState)?setTimeout(function(){i.domReady(e)},9):e()},addEvent:function(e,t,n){var r=function(t){t=t||window.event;var r=n.apply(e,[t,t.target||t.srcElement]);return!1===r&&(t.preventDefault?t.preventDefault():(t.returnValue=!1,t.cancelBubble=!0)),r};return e.attachEvent?e.attachEvent("on"+t,r):e.addEventListener(t,r,!1),r},removeEvent:function(e,t,n){e.detachEvent?e.detachEvent("on"+t,n):e.removeEventListener(t,n,!1)},hasClassName:function(e,t){if(!(e=i.$(e)))return!1;var n=e.className;return 0<n.length&&(n==t||RegExp("(^|\\s)"+t+"(\\s|$)").test(n))},addClassName:function(e,t){(e=i.$(e))&&!i.hasClassName(e,t)&&(e.className+=(e.className?" ":"")+t)},removeClassName:function(e,t){if(e=i.$(e))e.className=i.trimString(e.className.replace(RegExp("(^|\\s+)"+t+"(\\s+|$)")," "))},isFixed:function(e){do if("fixed"===i.getStyle(e,"position"))return!0;while(e=e.offsetParent);return!1},scrollContainer:function(e){do{var t=i.getStyle(e,"overflow");if("auto"===t||"scroll"===t)return e}while((e=e.parentNode)&&e!=window.document.body);return null},getPosition:function(e,t){var n=e.offsetLeft,r=e.offsetTop,i={};if(!t)for(;e=e.offsetParent;)n+=e.offsetLeft,r+=e.offsetTop;return i[0]=i.left=n,i[1]=i.top=r,i},getHeight:function(e){return e.offsetHeight||e.scrollHeight},getWidth:function(e){return e.offsetWidth||e.scrollWidth},trimString:function(e){return e.replace(/^\s+/,"").replace(/\s+$/,"")},merge:function(){for(var e=!0===arguments[0],t={},n=e?1:0;n<arguments.length;n++){var r=t,i=arguments[n];if("object"==typeof i){var s=void 0;for(s in i)i.hasOwnProperty(s)&&(e&&"object"==typeof r[s]&&"object"==typeof i[s]?_update(r[s],i[s]):r[s]=i[s])}}return t},isArray:function(e){return"[object Array]"==Object.prototype.toString.call(e)}};"function"==typeof document.addEventListener&&n.util.domReady(function(){for(var e=i.$$(".auto-kal"),t=e.length,r,s;t--;)r=e[t],s=r.getAttribute("data-kal"),s=null==s||""==s?{}:(new Function("return {"+s+"};"))(),"INPUT"===r.tagName?new n.Input(r,s):new n(i.merge(s,{attachTo:r}))}),n.Input=function(e,t){if("function"==typeof document.addEventListener||i.isIE8()){var r=this.input=i.$(e),s,o;if(!r||"INPUT"!==r.tagName)throw"First argument for Kalendae.Input must be an <input> element or a valid element id.";var u=this,a=u.classes;o=u.settings=i.merge(u.defaults,t),o.attachTo=window.document.body,o.selected?s=!0:o.selected=r.value,n.call(u,o),o.closeButton&&(o=i.make("a",{"class":a.closeButton},u.container),i.addEvent(o,"click",function(){r.blur()})),s&&(r.value=u.getSelected()),s=u.container;var f=!1;s.style.display="none",i.addClassName(s,a.positioned),i.addEvent(s,"mousedown",function(){f=!0}),i.addEvent(window.document,"mousedown",function(){f=!1}),i.addEvent(r,"focus",function(){u.setSelected(this.value),u.show()}),i.addEvent(r,"blur",function(){f&&i.isIE8()?(f=!1,r.focus()):u.hide()}),i.addEvent(r,"keyup",function(){u.setSelected(this.value)}),(a=i.scrollContainer(r))&&i.addEvent(a,"scroll",function(){r.blur()}),u.subscribe("change",function(){r.value=u.getSelected()})}},n.Input.prototype=i.merge(n.prototype,{defaults:i.merge(n.prototype.defaults,{format:"MM/DD/YYYY",side:"bottom",closeButton:!0,offsetLeft:0,offsetTop:0}),classes:i.merge(n.prototype.classes,{positioned:"k-floating",closeButton:"k-btn-close"}),show:function(){var e=this.container,t=e.style,n=this.input,r=i.getPosition(n),s=i.scrollContainer(n),s=s?s.scrollTop:0,o=this.settings;t.display="";switch(o.side){case"left":t.left=r.left-i.getWidth(e)+o.offsetLeft+"px",t.top=r.top+o.offsetTop-s+"px";break;case"right":t.left=r.left+i.getWidth(n)+"px",t.top=r.top+o.offsetTop-s+"px";break;case"top":t.left=r.left+o.offsetLeft+"px",t.top=r.top-i.getHeight(e)+o.offsetTop-s+"px";break;default:t.left=r.left+o.offsetLeft+"px",t.top=r.top+i.getHeight(n)+o.offsetTop-s+"px"}t.position=i.isFixed(n)?"fixed":"absolute",this.publish("show",this)},hide:function(){this.container.style.display="none",this.publish("hide",this)}});var s=function(e){e||(e=this);var t=e.c_||{};e.publish=function(e,n,r){for(var i=(e=t[e])?e.length:0,s;i--;)if(s=e[i].apply(n,r||[]),"boolean"==typeof s)return s},e.subscribe=function(e,n,r){return t[e]||(t[e]=[]),r?t[e].push(n):t[e].unshift(n),[e,n]},e.unsubscribe=function(e){var n=t[e[0]];e=e[1];for(var r=n?n.length:0;r--;)n[r]===e&&n.splice(r,1)}};(function(e){function t(e,t){return function(n){return a(e.call(this,n),t)}}function n(e){return function(t){return this.lang().ordinal(e.call(this,t))}}function r(){}function i(e){o(this,e)}function s(e){var t=this._data={},n=e.years||e.year||e.y||0,r=e.months||e.month||e.M||0,i=e.weeks||e.week||e.w||0,s=e.days||e.day||e.d||0,o=e.hours||e.hour||e.h||0,a=e.minutes||e.minute||e.m||0,f=e.seconds||e.second||e.s||0;e=e.milliseconds||e.millisecond||e.ms||0,this._milliseconds=e+1e3*f+6e4*a+36e5*o,this._days=s+7*i,this._months=r+12*n,t.milliseconds=e%1e3,f+=u(e/1e3),t.seconds=f%60,a+=u(f/60),t.minutes=a%60,o+=u(a/60),t.hours=o%24,s+=u(o/24),s+=7*i,t.days=s%30,r+=u(s/30),t.months=r%12,n+=u(r/12),t.years=n}function o(e,t){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n]);return e}function u(e){return 0>e?Math.ceil(e):Math.floor(e)}function a(e,t){for(var n=e+"";n.length<t;)n="0"+n;return n}function f(e,t,n){var r=t._milliseconds,i=t._days;t=t._months,r&&e._d.setTime(+e+r*n),i&&e.date(e.date()+i*n),t&&(r=e.date(),e.date(1).month(e.month()+t*n).date(Math.min(r,e.daysInMonth())))}function l(e,t){var n=Math.min(e.length,t.length),r=Math.abs(e.length-t.length),i=0,s;for(s=0;s<n;s++)~~e[s]!==~~t[s]&&i++;return i+r}function c(e){return e?(!T[e]&&N&&require("./lang/"+e),T[e]):E.fn._lang}function h(e){switch(e){case"DDDD":return M;case"YYYY":return _;case"YYYYY":return D;case"S":case"SS":case"SSS":case"DDD":return O;case"MMM":case"MMMM":case"dd":case"ddd":case"dddd":case"a":case"A":return P;case"X":return j;case"Z":case"ZZ":return H;case"T":return B;case"MM":case"DD":case"YY":case"HH":case"hh":case"mm":case"ss":case"M":case"D":case"d":case"H":case"h":case"m":case"s":return A;default:return RegExp(e.replace("\\",""))}}function p(e){var t,n=[];if(!e._d){for(t=0;7>t;t++)e._a[t]=n[t]=null==e._a[t]?2===t?1:0:e._a[t];n[3]+=e._tzh||0,n[4]+=e._tzm||0,t=new Date(0),e._useUTC?(t.setUTCFullYear(n[0],n[1],n[2]),t.setUTCHours(n[3],n[4],n[5],n[6])):(t.setFullYear(n[0],n[1],n[2]),t.setHours(n[3],n[4],n[5],n[6])),e._d=t}}function d(e){var t=e._f.match(k),n=e._i,r,i;e._a=[];for(r=0;r<t.length;r++)if((i=(h(t[r]).exec(n)||[])[0])&&(n=n.slice(n.indexOf(i)+i.length)),V[t[r]]){var s=e,o=void 0,u=s._a;switch(t[r]){case"M":case"MM":u[1]=null==i?0:~~i-1;break;case"MMM":case"MMMM":o=c(s._l).monthsParse(i),null!=o?u[1]=o:s._isValid=!1;break;case"D":case"DD":case"DDD":case"DDDD":null!=i&&(u[2]=~~i);break;case"YY":u[0]=~~i+(68<~~i?1900:2e3);break;case"YYYY":case"YYYYY":u[0]=~~i;break;case"a":case"A":s._isPm="pm"===(i+"").toLowerCase();break;case"H":case"HH":case"h":case"hh":u[3]=~~i;break;case"m":case"mm":u[4]=~~i;break;case"s":case"ss":u[5]=~~i;break;case"S":case"SS":case"SSS":u[6]=~~(1e3*("0."+i));break;case"X":s._d=new Date(1e3*parseFloat(i));break;case"Z":case"ZZ":s._useUTC=!0,(o=(i+"").match(q))&&o[1]&&(s._tzh=~~o[1]),o&&o[2]&&(s._tzm=~~o[2]),o&&"+"===o[0]&&(s._tzh=-s._tzh,s._tzm=-s._tzm)}null==i&&(s._isValid=!1)}e._isPm&&12>e._a[3]&&(e._a[3]+=12),!1===e._isPm&&12===e._a[3]&&(e._a[3]=0),p(e)}function v(e,t,n,r,i){return i.relativeTime(t||1,!!n,e,r)}function m(e,t,n){return t=n-t,n-=e.day(),n>t&&(n-=7),n<t-7&&(n+=7),Math.ceil(E(e).add("d",n).dayOfYear()/7)}function g(t){var n=t._i,r=t._f;if(null===n||""===n)return null;"string"==typeof n&&(t._i=n=c().preparse(n));if(E.isMoment(n))t=o({},n),t._d=new Date(+n._d);else if(r)if("[object Array]"===Object.prototype.toString.call(r)){for(var n=t,s,u,a=99;n._f.length;){s=o({},n),s._f=n._f.pop(),d(s),r=new i(s);if(r.isValid()){u=r;break}s=l(s._a,r.toArray()),s<a&&(a=s,u=r)}o(n,u)}else d(t);else if(u=t,n=u._i,r=C.exec(n),n===e)u._d=new Date;else if(r)u._d=new Date(+r[1]);else if("string"==typeof n)if(r=u._i,F.exec(r)){u._f="YYYY-MM-DDT";for(n=0;4>n;n++)if(I[n][1].exec(r)){u._f+=I[n][0];break}H.exec(r)&&(u._f+=" Z"),d(u)}else u._d=new Date(r);else"[object Array]"===Object.prototype.toString.call(n)?(u._a=n.slice(0),p(u)):u._d=n instanceof Date?new Date(+n):new Date(n);return new i(t)}function y(e,t){E.fn[e]=E.fn[e+"s"]=function(e){var n=this._isUTC?"UTC":"";return null!=e?(this._d["set"+n+t](e),this):this._d["get"+n+t]()}}function b(e){E.duration.fn[e]=function(){return this._data[e]}}function w(e,t){E.duration.fn["as"+e]=function(){return+this/t}}for(var E,S=Math.round,x,T={},N="undefined"!=typeof module&&module.exports,C=/^\/?Date\((\-?\d+)/i,k=/(\[[^\[]*\])|(\\)?(Mo|MM?M?M?|Do|DDDo|DD?D?D?|ddd?d?|do?|w[o|w]?|W[o|W]?|YYYYY|YYYY|YY|a|A|hh?|HH?|mm?|ss?|SS?S?|X|zz?|ZZ?|.)/g,L=/(\[[^\[]*\])|(\\)?(LT|LL?L?L?|l{1,4})/g,A=/\d\d?/,O=/\d{1,3}/,M=/\d{3}/,_=/\d{1,4}/,D=/[+\-]?\d{1,6}/,P=/[0-9]*[a-z\u00A0-\u05FF\u0700-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF]+|[\u0600-\u06FF]+\s*?[\u0600-\u06FF]+/i,H=/Z|[\+\-]\d\d:?\d\d/i,B=/T/i,j=/[\+\-]?\d+(\.\d{1,3})?/,F=/^\s*\d{4}-\d\d-\d\d((T| )(\d\d(:\d\d(:\d\d(\.\d\d?\d?)?)?)?)?([\+\-]\d\d:?\d\d)?)?/,I=[["HH:mm:ss.S",/(T| )\d\d:\d\d:\d\d\.\d{1,3}/],["HH:mm:ss",/(T| )\d\d:\d\d:\d\d/],["HH:mm",/(T| )\d\d:\d\d/],["HH",/(T| )\d\d/]],q=/([\+\-]|\d\d)/gi,R="Month Date Hours Minutes Seconds Milliseconds".split(" "),U={Milliseconds:1,Seconds:1e3,Minutes:6e4,Hours:36e5,Days:864e5,Months:2592e6,Years:31536e6},z={},W="DDD w W M D d".split(" "),X="MDHhmswW".split(""),V={M:function(){return this.month()+1},MMM:function(e){return this.lang().monthsShort(this,e)},MMMM:function(e){return this.lang().months(this,e)},D:function(){return this.date()},DDD:function(){return this.dayOfYear()},d:function(){return this.day()},dd:function(e){return this.lang().weekdaysMin(this,e)},ddd:function(e){return this.lang().weekdaysShort(this,e)},dddd:function(e){return this.lang().weekdays(this,e)},w:function(){return this.week()},W:function(){return this.isoWeek()},YY:function(){return a(this.year()%100,2)},YYYY:function(){return a(this.year(),4)},YYYYY:function(){return a(this.year(),5)},a:function(){return this.lang().meridiem(this.hours(),this.minutes(),!0)},A:function(){return this.lang().meridiem(this.hours(),this.minutes(),!1)},H:function(){return this.hours()},h:function(){return this.hours()%12||12},m:function(){return this.minutes()},s:function(){return this.seconds()},S:function(){return~~(this.milliseconds()/100)},SS:function(){return a(~~(this.milliseconds()/10),2)},SSS:function(){return a(this.milliseconds(),3)},Z:function(){var e=-this.zone(),t="+";return 0>e&&(e=-e,t="-"),t+a(~~(e/60),2)+":"+a(~~e%60,2)},ZZ:function(){var e=-this.zone(),t="+";return 0>e&&(e=-e,t="-"),t+a(~~(10*e/6),4)},X:function(){return this.unix()}};W.length;)x=W.pop(),V[x+"o"]=n(V[x]);for(;X.length;)x=X.pop(),V[x+x]=t(V[x],2);V.DDDD=t(V.DDD,3),r.prototype={set:function(e){var t,n;for(n in e)t=e[n],"function"==typeof t?this[n]=t:this["_"+n]=t},_months:"January February March April May June July August September October November December".split(" "),months:function(e){return this._months[e.month()]},_monthsShort:"Jan Feb Mar Apr May Jun Jul Aug Sep Oct Nov Dec".split(" "),monthsShort:function(e){return this._monthsShort[e.month()]},monthsParse:function(e){var t,n;this._monthsParse||(this._monthsParse=[]);for(t=0;12>t;t++)if(this._monthsParse[t]||(n=E([2e3,t]),n="^"+this.months(n,"")+"|^"+this.monthsShort(n,""),this._monthsParse[t]=RegExp(n.replace(".",""),"i")),this._monthsParse[t].test(e))return t},_weekdays:"Sunday Monday Tuesday Wednesday Thursday Friday Saturday".split(" "),weekdays:function(e){return this._weekdays[e.day()]},_weekdaysShort:"Sun Mon Tue Wed Thu Fri Sat".split(" "),weekdaysShort:function(e){return this._weekdaysShort[e.day()]},_weekdaysMin:"Su Mo Tu We Th Fr Sa".split(" "),weekdaysMin:function(e){return this._weekdaysMin[e.day()]},_longDateFormat:{LT:"h:mm A",L:"MM/DD/YYYY",LL:"MMMM D YYYY",LLL:"MMMM D YYYY LT",LLLL:"dddd, MMMM D YYYY LT"},longDateFormat:function(e){var t=this._longDateFormat[e];return!t&&this._longDateFormat[e.toUpperCase()]&&(t=this._longDateFormat[e.toUpperCase()].replace(/MMMM|MM|DD|dddd/g,function(e){return e.slice(1)}),this._longDateFormat[e]=t),t},meridiem:function(e,t,n){return 11<e?n?"pm":"PM":n?"am":"AM"},_calendar:{sameDay:"[Today at] LT",nextDay:"[Tomorrow at] LT",nextWeek:"dddd [at] LT",lastDay:"[Yesterday at] LT",lastWeek:"[last] dddd [at] LT",sameElse:"L"},calendar:function(e,t){var n=this._calendar[e];return"function"==typeof n?n.apply(t):n},_relativeTime:{future:"in %s",past:"%s ago",s:"a few seconds",m:"a minute",mm:"%d minutes",h:"an hour",hh:"%d hours",d:"a day",dd:"%d days",M:"a month",MM:"%d months",y:"a year",yy:"%d years"},relativeTime:function(e,t,n,r){var i=this._relativeTime[n];return"function"==typeof i?i(e,t,n,r):i.replace(/%d/i,e)},pastFuture:function(e,t){var n=this._relativeTime[0<e?"future":"past"];return"function"==typeof n?n(t):n.replace(/%s/i,t)},ordinal:function(e){return this._ordinal.replace("%d",e)},_ordinal:"%d",preparse:function(e){return e},postformat:function(e){return e},week:function(e){return m(e,this._week.dow,this._week.doy)},_week:{dow:0,doy:6}},E=function(e,t,n){return g({_i:e,_f:t,_l:n,_isUTC:!1})},E.utc=function(e,t,n){return g({_useUTC:!0,_isUTC:!0,_l:n,_i:e,_f:t})},E.unix=function(e){return E(1e3*e)},E.duration=function(e,t){var n=E.isDuration(e),r="number"==typeof e,i=n?e._data:r?{}:e;return r&&(t?i[t]=e:i.milliseconds=e),r=new s(i),n&&e.hasOwnProperty("_lang")&&(r._lang=e._lang),r},E.version="2.0.0",E.defaultFormat="YYYY-MM-DDTHH:mm:ssZ",E.lang=function(e,t){if(!e)return E.fn._lang._abbr;t?(t.abbr=e,T[e]||(T[e]=new r),T[e].set(t)):T[e]||c(e),E.duration.fn._lang=E.fn._lang=c(e)},E.langData=function(e){return e&&e._lang&&e._lang._abbr&&(e=e._lang._abbr),c(e)},E.isMoment=function(e){return e instanceof i},E.isDuration=function(e){return e instanceof s},E.fn=i.prototype={clone:function(){return E(this)},valueOf:function(){return+this._d},unix:function(){return Math.floor(+this._d/1e3)},toString:function(){return this.format("ddd MMM DD YYYY HH:mm:ss [GMT]ZZ")},toDate:function(){return this._d},toJSON:function(){return E.utc(this).format("YYYY-MM-DD[T]HH:mm:ss.SSS[Z]")},toArray:function(){return[this.year(),this.month(),this.date(),this.hours(),this.minutes(),this.seconds(),this.milliseconds()]},isValid:function(){return null==this._isValid&&(this._isValid=this._a?!l(this._a,(this._isUTC?E.utc(this._a):E(this._a)).toArray()):!isNaN(this._d.getTime())),!!this._isValid},utc:function(){return this._isUTC=!0,this},local:function(){return this._isUTC=!1,this},format:function(e){var t=this;e=e||E.defaultFormat;for(var n=function(e){return t.lang().longDateFormat(e)||e},r=5;r--&&L.test(e);)e=e.replace(L,n);if(!z[e]){var i=n=e,s=i.match(k),o,u;o=0;for(u=s.length;o<u;o++)if(V[s[o]])s[o]=V[s[o]];else{var r=s,a=o,f;f=s[o],f=f.match(/\[.*\]/)?f.replace(/^\[|\]$/g,""):f.replace(/\\/g,""),r[a]=f}z[n]=function(e){var t="";for(o=0;o<u;o++)t+="function"==typeof s[o].call?s[o].call(e,i):s[o];return t}}return e=z[e](t),this.lang().postformat(e)},add:function(e,t){var n;return n="string"==typeof e?E.duration(+t,e):E.duration(e,t),f(this,n,1),this},subtract:function(e,t){var n;return n="string"==typeof e?E.duration(+t,e):E.duration(e,t),f(this,n,-1),this},diff:function(e,t,n){e=this._isUTC?E(e).utc():E(e).local();var r=6e4*(this.zone()-e.zone()),i;return t&&(t=t.replace(/s$/,"")),"year"===t||"month"===t?(r=432e5*(this.daysInMonth()+e.daysInMonth()),i=12*(this.year()-e.year())+(this.month()-e.month()),i+=(this-E(this).startOf("month")-(e-E(e).startOf("month")))/r,"year"===t&&(i/=12)):(r=this-e-r,i="second"===t?r/1e3:"minute"===t?r/6e4:"hour"===t?r/36e5:"day"===t?r/864e5:"week"===t?r/6048e5:r),n?i:u(i)},from:function(e,t){return E.duration(this.diff(e)).lang(this.lang()._abbr).humanize(!t)},fromNow:function(e){return this.from(E(),e)},calendar:function(){var e=this.diff(E().startOf("day"),"days",!0);return this.format(this.lang().calendar(-6>e?"sameElse":-1>e?"lastWeek":0>e?"lastDay":1>e?"sameDay":2>e?"nextDay":7>e?"nextWeek":"sameElse",this))},isLeapYear:function(){var e=this.year();return 0===e%4&&0!==e%100||0===e%400},isDST:function(){return this.zone()<E([this.year()]).zone()||this.zone()<E([this.year(),5]).zone()},day:function(e){var t=this._isUTC?this._d.getUTCDay():this._d.getDay();return null==e?t:this.add({d:e-t})},startOf:function(e){e=e.replace(/s$/,"");switch(e){case"year":this.month(0);case"month":this.date(1);case"week":case"day":this.hours(0);case"hour":this.minutes(0);case"minute":this.seconds(0);case"second":this.milliseconds(0)}return"week"===e&&this.day(0),this},endOf:function(e){return this.startOf(e).add(e.replace(/s?$/,"s"),1).subtract("ms",1)},isAfter:function(e,t){return t="undefined"!=typeof t?t:"millisecond",+this.clone().startOf(t)>+E(e).startOf(t)},isBefore:function(e,t){return t="undefined"!=typeof t?t:"millisecond",+this.clone().startOf(t)<+E(e).startOf(t)},isSame:function(e,t){return t="undefined"!=typeof t?t:"millisecond",+this.clone().startOf(t)===+E(e).startOf(t)},zone:function(){return this._isUTC?0:this._d.getTimezoneOffset()},daysInMonth:function(){return E.utc([this.year(),this.month()+1,0]).date()},dayOfYear:function(e){var t=S((E(this).startOf("day")-E(this).startOf("year"))/864e5)+1;return null==e?t:this.add("d",e-t)},isoWeek:function(e){var t=m(this,1,4);return null==e?t:this.add("d",7*(e-t))},week:function(e){var t=this.lang().week(this);return null==e?t:this.add("d",7*(e-t))},lang:function(t){return t===e?this._lang:(this._lang=c(t),this)}};for(x=0;x<R.length;x++)y(R[x].toLowerCase().replace(/s$/,""),R[x]);y("year","FullYear"),E.fn.days=E.fn.day,E.fn.weeks=E.fn.week,E.fn.isoWeeks=E.fn.isoWeek,E.duration.fn=s.prototype={weeks:function(){return u(this.days()/7)},valueOf:function(){return this._milliseconds+864e5*this._days+2592e6*this._months},humanize:function(e){var t=+this,n;n=!e;var r=this.lang(),i=S(Math.abs(t)/1e3),s=S(i/60),o=S(s/60),u=S(o/24),a=S(u/365),i=45>i&&["s",i]||1===s&&["m"]||45>s&&["mm",s]||1===o&&["h"]||22>o&&["hh",o]||1===u&&["d"]||25>=u&&["dd",u]||45>=u&&["M"]||345>u&&["MM",S(u/30)]||1===a&&["y"]||["yy",a];return i[2]=n,i[3]=0<t,i[4]=r,n=v.apply({},i),e&&(n=this.lang().pastFuture(t,n)),this.lang().postformat(n)},lang:E.fn.lang};for(x in U)U.hasOwnProperty(x)&&(w(x,U[x]),b(x.toLowerCase()));w("Weeks",6048e5),E.lang("en",{ordinal:function(e){var t=e%10;return e+(1===~~(e%100/10)?"th":1===t?"st":2===t?"nd":3===t?"rd":"th")}}),this.moment=E}).call("undefined"==typeof n?window:n);if(!n.moment){if(!window.moment)throw"Kalendae requires moment.js. You must use kalendae.standalone.js if moment is not available on the page.";n.moment=window.moment}t=n.moment,t.fn.stripTime=function(){return this._d=new Date(864e5*Math.floor(this._d.valueOf()/864e5)),this},t.fn.yearDay=function(e){var t=Math.floor(this._d/864e5);return"undefined"==typeof e?t:this.add({d:e-t})},e=n.moment().stripTime(),"undefined"!=typeof jQuery&&("function"==typeof document.addEventListener||i.isIE8())&&(jQuery.fn.kalendae=function(e){return this.each(function(t,r){"INPUT"===r.tagName?$(r).data("kalendae",new n.Input(r,e)):$(r).data("kalendae",new n($.extend({},{attachTo:r},e)))}),this})}(),define("kalendae",function(e){return function(){var t,n;return t||e.Kalendae}}(this)),define("text!templates/agreement/edit/payment_item_tpl.html",[],function(){return'<div>\n	<input class="amount" contenteditable ${{amount}} value="${{amount}}" style="display:inline-block;width:214px;">\n	<input type="text" value="{{title}}" class="title">\n	{{#unless required}}\n		<input {{#if dateExpected}} placeholder="{{dateFormat dateExpected}}"{{else}} placeholder="Choose Date" {{/if}} class="kal" name="dateExpected" type="text">\n	{{/unless}}\n</div>\n<input class="edit_work_item add_work_item_input" type="text" name="" value="" placeholder="Add work item" id="" size="50">\n<a class="add-more add_comment">Add Work Item</a>\n<ul class="scope_items_container create_scope_item_container"></ul>\n<fieldset class="removeButton">\n	<p class="remove_icon">\n		<a id="remove_icon">Remove milestone</a>\n	</p>\n</fieldset>'}),define("text!templates/agreement/edit/scope_item_tpl.html",[],function(){return'<li>\n	<div class="create_scope_item">\n		<label class="create_scope_label">{{text}}</label>\n		<a class="create_scope_item_delete">X</a>\n	</div> \n</li>'}),define("views/agreement/edit/scope_item_view",["backbone","handlebars","text!templates/agreement/edit/scope_item_tpl.html"],function(e,t,n){var r=e.View.extend({template:t.compile(n),render:function(){return this.$el.html(this.template(this.model.toJSON())),this},events:{"click a":"removeItem"},removeItem:function(e){this.model.collection.remove(this.model)}});return r}),define("views/agreement/edit/payment_item_view",["backbone","handlebars","underscore","marionette","kalendae","text!templates/agreement/edit/payment_item_tpl.html","views/agreement/edit/scope_item_view"],function(e,t,n,r,i,s,o){t.registerHelper("dateFormat",function(e){return e.format("MMM D, YYYY")});var u=e.Marionette.CompositeView.extend({template:t.compile(s),itemView:o,itemViewContainer:".scope_items_container",initialize:function(){this.collection=this.model.get("scopeItems")},events:{"blur .amount":"updateAmount","blur .title":"updateTitle","click #remove_icon":"removeMilestone","keypress .edit_work_item":"addScopeItem","click .add_comment":"addComment","focus .kal":"triggerCalender","focus input":"fadeError"},updateAmount:function(e){var t=e.target.value,n=t.substring(0,1)==="$"?t.substring(1):t;this.model.set("amount",n)},updateTitle:function(e){this.model.set("title",e.target.value)},removeMilestone:function(){this.model.collection.remove(this.model)},addScopeItem:function(e){e.keyCode==13&&(this.collection.add({text:e.target.value}),e.target.value=null)},triggerCalender:function(e){this.calendar||(this.calendar=new i.Input(this.$(".kal")[0],{}),this.calendar.subscribe("date-clicked",n.bind(this.setDate,this)))},setDate:function(e,t){this.model.set("dateExpected",e),n.delay(this.closeCalendar,150),this.$(".kal").val(e.format("MM/DD/YYYY")),this.$(".kal").blur()},closeCalendar:function(){$(".kalendae").hide()},addComment:function(e){var t=$(e.target).prev(".add_work_item_input"),n=$("input"),r=$(e.target).next(".add_work_item_error");t.val()===""?(r.fadeIn("fast"),n.keypress(function(){$(".add_work_item_error").fadeOut("fast")}),t.focus()):(this.collection.add({text:t.val()}),t.val(null),t.focus())},fadeError:function(e){$(".add_work_item_error").fadeOut("fast")}});return u}),define("views/agreement/edit/payments_edit_view",["backbone","handlebars","underscore","marionette","text!templates/agreement/edit/payment_edit_tpl.html","views/agreement/edit/payment_item_view","views/agreement/payment_item_view"],function(e,t,n,r,i,s,o){var u=e.Marionette.CompositeView.extend({template:t.compile(i),itemView:s,itemViewContainer:"ul",initialize:function(){this.collection=this.model.get("payments")},events:{"click #addMoreButton":"addMilestone"},getItemView:function(e){var t=e.get("currentStatus");return!t||t.get("action")!=="accepted"&&t.get("action")!=="submitted"?s:o},addMilestone:function(e){this.collection.add({amount:0,title:"New Milestone"})}});return u}),typeof Object.create!="function"&&(Object.create=function(e){function t(){}return t.prototype=e,new t}),function(e){var t={init:function(t){return this.options=e.extend({},e.noty.defaults,t),this.options.layout=this.options.custom?e.noty.layouts.inline:e.noty.layouts[this.options.layout],this.options.theme=e.noty.themes[this.options.theme],delete t.layout,delete t.theme,this.options=e.extend({},this.options,this.options.layout.options),this.options.id="noty_"+(new Date).getTime()*Math.floor(Math.random()*1e6),this.options=e.extend({},this.options,t),this._build(),this},_build:function(){var t=e('<div class="noty_bar"></div>').attr("id",this.options.id);t.append(this.options.template).find(".noty_text").html(this.options.text),this.$bar=this.options.layout.parent.object!==null?e(this.options.layout.parent.object).css(this.options.layout.parent.css).append(t):t;if(this.options.buttons){this.options.closeWith=[],this.options.timeout=!1;var n=e("<div/>").addClass("noty_buttons");this.options.layout.parent.object!==null?this.$bar.find(".noty_bar").append(n):this.$bar.append(n);var r=this;e.each(this.options.buttons,function(t,n){var i=e("<button/>").addClass(n.addClass?n.addClass:"gray").html(n.text).appendTo(r.$bar.find(".noty_buttons")).bind("click",function(){e.isFunction(n.onClick)&&n.onClick.call(i,r)})})}this.$message=this.$bar.find(".noty_message"),this.$closeButton=this.$bar.find(".noty_close"),this.$buttons=this.$bar.find(".noty_buttons"),e.noty.store[this.options.id]=this},show:function(){var t=this;return e(t.options.layout.container.selector).append(t.$bar),t.options.theme.style.apply(t),e.type(t.options.layout.css)==="function"?this.options.layout.css.apply(t.$bar):t.$bar.css(this.options.layout.css||{}),t.$bar.addClass(t.options.layout.addClass),t.options.layout.container.style.apply(e(t.options.layout.container.selector)),t.options.theme.callback.onShow.apply(this),e.inArray("click",t.options.closeWith)>-1&&t.$bar.css("cursor","pointer").one("click",function(e){t.stopPropagation(e),t.options.callback.onCloseClick&&t.options.callback.onCloseClick.apply(t),t.close()}),e.inArray("hover",t.options.closeWith)>-1&&t.$bar.one("mouseenter",function(){t.close()}),e.inArray("button",t.options.closeWith)>-1&&t.$closeButton.one("click",function(e){t.stopPropagation(e),t.close()}),e.inArray("button",t.options.closeWith)==-1&&t.$closeButton.remove(),t.options.callback.onShow&&t.options.callback.onShow.apply(t),t.$bar.animate(t.options.animation.open,t.options.animation.speed,t.options.animation.easing,function(){t.options.callback.afterShow&&t.options.callback.afterShow.apply(t),t.shown=!0}),t.options.timeout&&t.$bar.delay(t.options.timeout).promise().done(function(){t.close()}),this},close:function(){if(this.closed)return;if(this.$bar&&this.$bar.hasClass("i-am-closing-now"))return;var t=this;if(!this.shown){var n=[];e.each(e.noty.queue,function(e,r){r.options.id!=t.options.id&&n.push(r)}),e.noty.queue=n;return}t.$bar.addClass("i-am-closing-now"),t.options.callback.onClose&&t.options.callback.onClose.apply(t),t.$bar.clearQueue().stop().animate(t.options.animation.close,t.options.animation.speed,t.options.animation.easing,function(){t.options.callback.afterClose&&t.options.callback.afterClose.apply(t)}).promise().done(function(){t.options.modal&&(e.notyRenderer.setModalCount(-1),e.notyRenderer.getModalCount()==0&&e(".noty_modal").fadeOut("fast",function(){e(this).remove()})),e.notyRenderer.setLayoutCountFor(t,-1),e.notyRenderer.getLayoutCountFor(t)==0&&e(t.options.layout.container.selector).remove(),typeof t.$bar!="undefined"&&t.$bar!==null&&(t.$bar.remove(),t.$bar=null,t.closed=!0),delete e.noty.store[t.options.id],t.options.theme.callback.onClose.apply(t),t.options.dismissQueue||(e.noty.ontap=!0,e.notyRenderer.render()),t.options.maxVisible>0&&t.options.dismissQueue&&e.notyRenderer.render()})},setText:function(e){return this.closed||(this.options.text=e,this.$bar.find(".noty_text").html(e)),this},setType:function(e){return this.closed||(this.options.type=e,this.options.theme.style.apply(this),this.options.theme.callback.onShow.apply(this)),this},setTimeout:function(e){if(!this.closed){var t=this;this.options.timeout=e,t.$bar.delay(t.options.timeout).promise().done(function(){t.close()})}return this},stopPropagation:function(e){e=e||window.event,typeof e.stopPropagation!="undefined"?e.stopPropagation():e.cancelBubble=!0},closed:!1,shown:!1};e.notyRenderer={},e.notyRenderer.init=function(n){var r=Object.create(t).init(n);return r.options.force?e.noty.queue.unshift(r):e.noty.queue.push(r),e.notyRenderer.render(),e.noty.returns=="object"?r:r.options.id},e.notyRenderer.render=function(){var t=e.noty.queue[0];e.type(t)==="object"?t.options.dismissQueue?t.options.maxVisible>0?e(t.options.layout.container.selector+" li").length<t.options.maxVisible&&e.notyRenderer.show(e.noty.queue.shift()):e.notyRenderer.show(e.noty.queue.shift()):e.noty.ontap&&(e.notyRenderer.show(e.noty.queue.shift()),e.noty.ontap=!1):e.noty.ontap=!0},e.notyRenderer.show=function(t){t.options.modal&&(e.notyRenderer.createModalFor(t),e.notyRenderer.setModalCount(1)),e(t.options.layout.container.selector).length==0?t.options.custom?t.options.custom.append(e(t.options.layout.container.object).addClass("i-am-new")):e("body").append(e(t.options.layout.container.object).addClass("i-am-new")):e(t.options.layout.container.selector).removeClass("i-am-new"),e.notyRenderer.setLayoutCountFor(t,1),t.show()},e.notyRenderer.createModalFor=function(t){e(".noty_modal").length==0&&e("<div/>").addClass("noty_modal").data("noty_modal_count",0).css(t.options.theme.modal.css).prependTo(e("body")).fadeIn("fast")},e.notyRenderer.getLayoutCountFor=function(t){return e(t.options.layout.container.selector).data("noty_layout_count")||0},e.notyRenderer.setLayoutCountFor=function(t,n){return e(t.options.layout.container.selector).data("noty_layout_count",e.notyRenderer.getLayoutCountFor(t)+n)},e.notyRenderer.getModalCount=function(){return e(".noty_modal").data("noty_modal_count")||0},e.notyRenderer.setModalCount=function(t){return e(".noty_modal").data("noty_modal_count",e.notyRenderer.getModalCount()+t)},e.fn.noty=function(t){return t.custom=e(this),e.notyRenderer.init(t)},e.noty={},e.noty.queue=[],e.noty.ontap=!0,e.noty.layouts={},e.noty.themes={},e.noty.returns="object",e.noty.store={},e.noty.get=function(t){return e.noty.store.hasOwnProperty(t)?e.noty.store[t]:!1},e.noty.close=function(t){return e.noty.get(t)?e.noty.get(t).close():!1},e.noty.setText=function(t,n){return e.noty.get(t)?e.noty.get(t).setText(n):!1},e.noty.setType=function(t,n){return e.noty.get(t)?e.noty.get(t).setType(n):!1},e.noty.clearQueue=function(){e.noty.queue=[]},e.noty.closeAll=function(){e.noty.clearQueue(),e.each(e.noty.store,function(e,t){t.close()})};var n=window.alert;e.noty.consumeAlert=function(t){window.alert=function(n){t?t.text=n:t={text:n},e.notyRenderer.init(t)}},e.noty.stopConsumeAlert=function(){window.alert=n},e.noty.defaults={layout:"top",theme:"defaultTheme",type:"alert",text:"",dismissQueue:!0,template:'<div class="noty_message"><span class="noty_text"></span><div class="noty_close"></div></div>',animation:{open:{height:"toggle"},close:{height:"toggle"},easing:"swing",speed:500},timeout:!1,force:!1,modal:!1,maxVisible:5,closeWith:["click"],callback:{onShow:function(){},afterShow:function(){},onClose:function(){},afterClose:function(){},onCloseClick:function(){}},buttons:!1},e(window).resize(function(){e.each(e.noty.layouts,function(t,n){n.container.style.apply(e(n.container.selector))})})}(jQuery),window.noty=function(t){var n=0,r={animateOpen:"animation.open",animateClose:"animation.close",easing:"animation.easing",speed:"animation.speed",onShow:"callback.onShow",onShown:"callback.afterShow",onClose:"callback.onClose",onCloseClick:"callback.onCloseClick",onClosed:"callback.afterClose"};return jQuery.each(t,function(e,i){if(r[e]){n++;var s=r[e].split(".");t[s[0]]||(t[s[0]]={}),t[s[0]][s[1]]=i?i:function(){},delete t[e]}}),t.closeWith||(t.closeWith=jQuery.noty.defaults.closeWith),t.hasOwnProperty("closeButton")&&(n++,t.closeButton&&t.closeWith.push("button"),delete t.closeButton),t.hasOwnProperty("closeOnSelfClick")&&(n++,t.closeOnSelfClick&&t.closeWith.push("click"),delete t.closeOnSelfClick),t.hasOwnProperty("closeOnSelfOver")&&(n++,t.closeOnSelfOver&&t.closeWith.push("hover"),delete t.closeOnSelfOver),t.hasOwnProperty("custom")&&(n++,t.custom.container!="null"&&(t.custom=t.custom.container)),t.hasOwnProperty("cssPrefix")&&(n++,delete t.cssPrefix),t.theme=="noty_theme_default"&&(n++,t.theme="defaultTheme"),t.hasOwnProperty("dismissQueue")||(t.dismissQueue=jQuery.noty.defaults.dismissQueue),t.hasOwnProperty("maxVisible")||(t.maxVisible=jQuery.noty.defaults.maxVisible),t.buttons&&jQuery.each(t.buttons,function(e,t){t.click&&(n++,t.onClick=t.click,delete t.click),t.type&&(n++,t.addClass=t.type,delete t.type)}),n&&typeof console!="undefined"&&console.warn&&console.warn("You are using noty v2 with v1.x.x options. @deprecated until v2.2.0 - Please update your options."),jQuery.notyRenderer.init(t)},define("noty",["jquery"],function(e){return function(){var t,n;return t||e.noty}}(this)),function(e){e.noty.layouts.inline={name:"inline",options:{},container:{object:'<ul id="noty_inline_layout_container" />',selector:"ul#noty_inline_layout_container",style:function(){e(this).css({width:"100%",height:"auto",margin:0,padding:0,listStyleType:"none",zIndex:9999999})}},parent:{object:"<li />",selector:"li",css:{}},css:{display:"none"},addClass:""}}(jQuery),define("noty-inline",["noty"],function(){}),function(e){e.noty.themes.defaultTheme={name:"defaultTheme",helpers:{borderFix:function(){if(this.options.dismissQueue){var t=this.options.layout.container.selector+" "+this.options.layout.parent.selector;switch(this.options.layout.name){case"top":e(t).css({borderRadius:"0px 0px 0px 0px"}),e(t).last().css({borderRadius:"0px 0px 5px 5px"});break;case"topCenter":case"topLeft":case"topRight":case"bottomCenter":case"bottomLeft":case"bottomRight":case"center":case"centerLeft":case"centerRight":case"inline":e(t).css({borderRadius:"0px 0px 0px 0px"}),e(t).first().css({"border-top-left-radius":"5px","border-top-right-radius":"5px"}),e(t).last().css({"border-bottom-left-radius":"5px","border-bottom-right-radius":"5px"});break;case"bottom":e(t).css({borderRadius:"0px 0px 0px 0px"}),e(t).first().css({borderRadius:"5px 5px 0px 0px"});break;default:}}}},modal:{css:{position:"fixed",width:"100%",height:"100%",backgroundColor:"#000",zIndex:1e4,opacity:.6,display:"none",left:0,top:0}},style:function(){this.$bar.css({overflow:"hidden",background:"url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABsAAAAoCAYAAAAPOoFWAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAAPZJREFUeNq81tsOgjAMANB2ov7/7ypaN7IlIwi9rGuT8QSc9EIDAsAznxvY4pXPKr05RUE5MEVB+TyWfCEl9LZApYopCmo9C4FKSMtYoI8Bwv79aQJU4l6hXXCZrQbokJEksxHo9KMOgc6w1atHXM8K9DVC7FQnJ0i8iK3QooGgbnyKgMDygBWyYFZoqx4qS27KqLZJjA1D0jK6QJcYEQEiWv9PGkTsbqxQ8oT+ZtZB6AkdsJnQDnMoHXHLGKOgDYuCWmYhEERCI5gaamW0bnHdA3k2ltlIN+2qKRyCND0bhqSYCyTB3CAOc4WusBEIpkeBuPgJMAAX8Hs1NfqHRgAAAABJRU5ErkJggg==') repeat-x scroll left top #fff"}),this.$message.css({fontSize:"13px",lineHeight:"16px",textAlign:"center",padding:"8px 10px 9px",width:"auto",position:"relative"}),this.$closeButton.css({position:"absolute",top:4,right:4,width:10,height:10,background:"url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAoAAAAKCAYAAACNMs+9AAAACXBIWXMAAAsTAAALEwEAmpwYAAAKT2lDQ1BQaG90b3Nob3AgSUNDIHByb2ZpbGUAAHjanVNnVFPpFj333vRCS4iAlEtvUhUIIFJCi4AUkSYqIQkQSoghodkVUcERRUUEG8igiAOOjoCMFVEsDIoK2AfkIaKOg6OIisr74Xuja9a89+bN/rXXPues852zzwfACAyWSDNRNYAMqUIeEeCDx8TG4eQuQIEKJHAAEAizZCFz/SMBAPh+PDwrIsAHvgABeNMLCADATZvAMByH/w/qQplcAYCEAcB0kThLCIAUAEB6jkKmAEBGAYCdmCZTAKAEAGDLY2LjAFAtAGAnf+bTAICd+Jl7AQBblCEVAaCRACATZYhEAGg7AKzPVopFAFgwABRmS8Q5ANgtADBJV2ZIALC3AMDOEAuyAAgMADBRiIUpAAR7AGDIIyN4AISZABRG8lc88SuuEOcqAAB4mbI8uSQ5RYFbCC1xB1dXLh4ozkkXKxQ2YQJhmkAuwnmZGTKBNA/g88wAAKCRFRHgg/P9eM4Ors7ONo62Dl8t6r8G/yJiYuP+5c+rcEAAAOF0ftH+LC+zGoA7BoBt/qIl7gRoXgugdfeLZrIPQLUAoOnaV/Nw+H48PEWhkLnZ2eXk5NhKxEJbYcpXff5nwl/AV/1s+X48/Pf14L7iJIEyXYFHBPjgwsz0TKUcz5IJhGLc5o9H/LcL//wd0yLESWK5WCoU41EScY5EmozzMqUiiUKSKcUl0v9k4t8s+wM+3zUAsGo+AXuRLahdYwP2SycQWHTA4vcAAPK7b8HUKAgDgGiD4c93/+8//UegJQCAZkmScQAAXkQkLlTKsz/HCAAARKCBKrBBG/TBGCzABhzBBdzBC/xgNoRCJMTCQhBCCmSAHHJgKayCQiiGzbAdKmAv1EAdNMBRaIaTcA4uwlW4Dj1wD/phCJ7BKLyBCQRByAgTYSHaiAFiilgjjggXmYX4IcFIBBKLJCDJiBRRIkuRNUgxUopUIFVIHfI9cgI5h1xGupE7yAAygvyGvEcxlIGyUT3UDLVDuag3GoRGogvQZHQxmo8WoJvQcrQaPYw2oefQq2gP2o8+Q8cwwOgYBzPEbDAuxsNCsTgsCZNjy7EirAyrxhqwVqwDu4n1Y8+xdwQSgUXACTYEd0IgYR5BSFhMWE7YSKggHCQ0EdoJNwkDhFHCJyKTqEu0JroR+cQYYjIxh1hILCPWEo8TLxB7iEPENyQSiUMyJ7mQAkmxpFTSEtJG0m5SI+ksqZs0SBojk8naZGuyBzmULCAryIXkneTD5DPkG+Qh8lsKnWJAcaT4U+IoUspqShnlEOU05QZlmDJBVaOaUt2ooVQRNY9aQq2htlKvUYeoEzR1mjnNgxZJS6WtopXTGmgXaPdpr+h0uhHdlR5Ol9BX0svpR+iX6AP0dwwNhhWDx4hnKBmbGAcYZxl3GK+YTKYZ04sZx1QwNzHrmOeZD5lvVVgqtip8FZHKCpVKlSaVGyovVKmqpqreqgtV81XLVI+pXlN9rkZVM1PjqQnUlqtVqp1Q61MbU2epO6iHqmeob1Q/pH5Z/YkGWcNMw09DpFGgsV/jvMYgC2MZs3gsIWsNq4Z1gTXEJrHN2Xx2KruY/R27iz2qqaE5QzNKM1ezUvOUZj8H45hx+Jx0TgnnKKeX836K3hTvKeIpG6Y0TLkxZVxrqpaXllirSKtRq0frvTau7aedpr1Fu1n7gQ5Bx0onXCdHZ4/OBZ3nU9lT3acKpxZNPTr1ri6qa6UbobtEd79up+6Ynr5egJ5Mb6feeb3n+hx9L/1U/W36p/VHDFgGswwkBtsMzhg8xTVxbzwdL8fb8VFDXcNAQ6VhlWGX4YSRudE8o9VGjUYPjGnGXOMk423GbcajJgYmISZLTepN7ppSTbmmKaY7TDtMx83MzaLN1pk1mz0x1zLnm+eb15vft2BaeFostqi2uGVJsuRaplnutrxuhVo5WaVYVVpds0atna0l1rutu6cRp7lOk06rntZnw7Dxtsm2qbcZsOXYBtuutm22fWFnYhdnt8Wuw+6TvZN9un2N/T0HDYfZDqsdWh1+c7RyFDpWOt6azpzuP33F9JbpL2dYzxDP2DPjthPLKcRpnVOb00dnF2e5c4PziIuJS4LLLpc+Lpsbxt3IveRKdPVxXeF60vWdm7Obwu2o26/uNu5p7ofcn8w0nymeWTNz0MPIQ+BR5dE/C5+VMGvfrH5PQ0+BZ7XnIy9jL5FXrdewt6V3qvdh7xc+9j5yn+M+4zw33jLeWV/MN8C3yLfLT8Nvnl+F30N/I/9k/3r/0QCngCUBZwOJgUGBWwL7+Hp8Ib+OPzrbZfay2e1BjKC5QRVBj4KtguXBrSFoyOyQrSH355jOkc5pDoVQfujW0Adh5mGLw34MJ4WHhVeGP45wiFga0TGXNXfR3ENz30T6RJZE3ptnMU85ry1KNSo+qi5qPNo3ujS6P8YuZlnM1VidWElsSxw5LiquNm5svt/87fOH4p3iC+N7F5gvyF1weaHOwvSFpxapLhIsOpZATIhOOJTwQRAqqBaMJfITdyWOCnnCHcJnIi/RNtGI2ENcKh5O8kgqTXqS7JG8NXkkxTOlLOW5hCepkLxMDUzdmzqeFpp2IG0yPTq9MYOSkZBxQqohTZO2Z+pn5mZ2y6xlhbL+xW6Lty8elQfJa7OQrAVZLQq2QqboVFoo1yoHsmdlV2a/zYnKOZarnivN7cyzytuQN5zvn//tEsIS4ZK2pYZLVy0dWOa9rGo5sjxxedsK4xUFK4ZWBqw8uIq2Km3VT6vtV5eufr0mek1rgV7ByoLBtQFr6wtVCuWFfevc1+1dT1gvWd+1YfqGnRs+FYmKrhTbF5cVf9go3HjlG4dvyr+Z3JS0qavEuWTPZtJm6ebeLZ5bDpaql+aXDm4N2dq0Dd9WtO319kXbL5fNKNu7g7ZDuaO/PLi8ZafJzs07P1SkVPRU+lQ27tLdtWHX+G7R7ht7vPY07NXbW7z3/T7JvttVAVVN1WbVZftJ+7P3P66Jqun4lvttXa1ObXHtxwPSA/0HIw6217nU1R3SPVRSj9Yr60cOxx++/p3vdy0NNg1VjZzG4iNwRHnk6fcJ3/ceDTradox7rOEH0x92HWcdL2pCmvKaRptTmvtbYlu6T8w+0dbq3nr8R9sfD5w0PFl5SvNUyWna6YLTk2fyz4ydlZ19fi753GDborZ752PO32oPb++6EHTh0kX/i+c7vDvOXPK4dPKy2+UTV7hXmq86X23qdOo8/pPTT8e7nLuarrlca7nuer21e2b36RueN87d9L158Rb/1tWeOT3dvfN6b/fF9/XfFt1+cif9zsu72Xcn7q28T7xf9EDtQdlD3YfVP1v+3Njv3H9qwHeg89HcR/cGhYPP/pH1jw9DBY+Zj8uGDYbrnjg+OTniP3L96fynQ89kzyaeF/6i/suuFxYvfvjV69fO0ZjRoZfyl5O/bXyl/erA6xmv28bCxh6+yXgzMV70VvvtwXfcdx3vo98PT+R8IH8o/2j5sfVT0Kf7kxmTk/8EA5jz/GMzLdsAAAAgY0hSTQAAeiUAAICDAAD5/wAAgOkAAHUwAADqYAAAOpgAABdvkl/FRgAAATpJREFUeNoszrFqVFEUheG19zlz7sQ7ijMQBAvfYBqbpJCoZSAQbOwEE1IHGytbLQUJ8SUktW8gCCFJMSGSNxCmFBJO7j5rpXD6n5/P5vM53H3b3T9LOiB5AQDuDjM7BnA7DMPHDGBH0nuSzwHsRcRVRNRSysuU0i6AOwA/02w2+9Fae00SEbEh6SGAR5K+k3zWWptKepCm0+kpyRoRGyRBcpPkDsn1iEBr7drdP2VJZyQXERGSPpiZAViTBACXKaV9kqd5uVzCzO5KKb/d/UZSDwD/eyxqree1VqSu6zKAF2Z2RPJJaw0rAkjOJT0m+SuT/AbgDcmnkmBmfwAsJL1dXQ8lWY6IGwB1ZbrOOb8zs8thGP4COFwx/mE8Ho9Go9ErMzvJOW/1fY/JZIJSypqZfXX3L13X9fcDAKJct1sx3OiuAAAAAElFTkSuQmCC)",display:"none",cursor:"pointer"}),this.$buttons.css({padding:5,textAlign:"right",borderTop:"1px solid #ccc",backgroundColor:"#fff"}),this.$buttons.find("button").css({marginLeft:5}),this.$buttons.find("button:first").css({marginLeft:0}),this.$bar.bind({mouseenter:function(){e(this).find(".noty_close").stop().fadeTo("normal",1)},mouseleave:function(){e(this).find(".noty_close").stop().fadeTo("normal",0)}});switch(this.options.layout.name){case"top":this.$bar.css({borderRadius:"0px 0px 5px 5px",borderBottom:"2px solid #eee",borderLeft:"2px solid #eee",borderRight:"2px solid #eee",boxShadow:"0 2px 4px rgba(0, 0, 0, 0.1)"});break;case"topCenter":case"center":case"bottomCenter":case"inline":this.$bar.css({borderRadius:"5px",border:"1px solid #eee",boxShadow:"0 2px 4px rgba(0, 0, 0, 0.1)"}),this.$message.css({fontSize:"13px",textAlign:"center"});break;case"topLeft":case"topRight":case"bottomLeft":case"bottomRight":case"centerLeft":case"centerRight":this.$bar.css({borderRadius:"5px",border:"1px solid #eee",boxShadow:"0 2px 4px rgba(0, 0, 0, 0.1)"}),this.$message.css({fontSize:"13px",textAlign:"left"});break;case"bottom":this.$bar.css({borderRadius:"5px 5px 0px 0px",borderTop:"2px solid #eee",borderLeft:"2px solid #eee",borderRight:"2px solid #eee",boxShadow:"0 -2px 4px rgba(0, 0, 0, 0.1)"});break;default:this.$bar.css({border:"2px solid #eee",boxShadow:"0 2px 4px rgba(0, 0, 0, 0.1)"})}switch(this.options.type){case"alert":case"notification":this.$bar.css({backgroundColor:"#FFF",borderColor:"#CCC",color:"#444"});break;case"warning":this.$bar.css({backgroundColor:"#FFEAA8",borderColor:"#FFC237",color:"#826200"}),this.$buttons.css({borderTop:"1px solid #FFC237"});break;case"error":this.$bar.css({backgroundColor:"red",borderColor:"darkred",color:"#FFF"}),this.$message.css({fontWeight:"bold"}),this.$buttons.css({borderTop:"1px solid darkred"});break;case"information":this.$bar.css({backgroundColor:"#57B7E2",borderColor:"#0B90C4",color:"#FFF"}),this.$buttons.css({borderTop:"1px solid #0B90C4"});break;case"success":this.$bar.css({backgroundColor:"lightgreen",borderColor:"#50C24E",color:"darkgreen"}),this.$buttons.css({borderTop:"1px solid #50C24E"});break;default:this.$bar.css({backgroundColor:"#FFF",borderColor:"#CCC",color:"#444"})}},callback:{onShow:function(){e.noty.themes.defaultTheme.helpers.borderFix.apply(this)},onClose:function(){e.noty.themes.defaultTheme.helpers.borderFix.apply(this)}}}}(jQuery),define("noty-default",["noty"],function(){}),define("text!templates/agreement/read/header_tpl.html",[],function(){return'<div id="intro" class="clear intro">\n	<div class="column-three-fourth">\n		<h1>{{model.title}}</h1>\n	</div>\n	<div class="column-one-fourth">\n		<ul class="action_button_container">\n			{{#if waiting}}\n				<h3 class="waiting">Waiting for the other party. Nothing to do here.</h3>\n			{{else}}\n				{{#if button1Title}}\n					<li><a id="action-button1" class="button action_button">{{button1Title}}</a></li>\n				{{/if}}\n			{{/if}}\n			{{#if button2Title}}<li><a id="action-button2" class="button action_button">{{button2Title}}</a></li>{{/if}}\n		</ul>\n	</div>\n</div>\n<div id="popup_container"></div>'}),define("views/agreement/read/header_states/base_state",["backbone","handlebars"],function(e,t){var n=e.View.extend({initialize:function(){this.userIsClient=this.model.get("clientID")==window.thisUser.id;if(this.model.get("draft"))return;this.status=this.model.get("currentStatus"),this.statusType=this.status.get("paymentID")?"payment":"agreement"},button1:function(e){},button2:function(e){},edit:function(){this.checkVersion(),window.location.hash="edit"},checkVersion:function(){if(!this.model.get("draft")){var e=this.model.get("version");this.model.set("version",e+1),this.model.unset("id"),this.model.set("draft",!0),console.log(this.model)}}});return n}),define("text!templates/agreement/pay_request_tpl.html",[],function(){return'\n      <header class="bottom_divider pay_header_container">\n        <h2 class="pay_header">Where should we send your funds?</h2>\n        {{#if bankAccounts}}\n        <h3>Select bank account</h3>\n          <ul class="payment_select_container">\n            <li>\n                {{#each bankAccounts}}\n                <input type="radio" class="select_bank_account" name="select_bank_account" value="{{uri}}">\n                <p class="payment_select_info first_select_info"><span>Account NickName:</span> {{nick_name}}</p>\n                <p class="payment_select_info"><span>Routing:</span> **** **** **** {{last_four_routing}}</p>\n                <p class="payment_select_info"><span>Account:</span> **** **** **** {{last_four_account}}</p>\n                {{/each}}\n                <h2> \n            </li>\n          </ul>\n         {{else}}\n          <h3>Please add a bank account in the <a href="/account#bankaccount">account</a> page to receive payment.</h3>\n         {{/if}}\n      </header>\n      <article>\n        <div class="line"></div>\n        <h2 class="pay_header pay_milestone">Get Paid for Milestone \n          <select id="milestoneToPay">{{#each payments}}\n            <option value="{{this.id}}">{{this.title}}</option>\n            {{/each}}\n            </select></h2>\n        <div id="paymentBreakout">\n          <ul class="line_item_container">\n            <li class="line_item"><span class="line_item_title line_item_title_small">Milestone Amount:</span> ${{milestonePayment}}</li>\n            <li class="line_item"><span class="line_item_title line_item_title_small">Wurk Happy Fee (5%):</span> ${{wurkHappyFee}}</li>\n            <li class="line_item line_item_total"><span class="line_item_title">You Will Receive:</span> ${{amountTotal}}</li>\n          </ul>\n        </div>\n        <a id="pay-button" class="button action_button pay_button">Request Payment</a>\n      </article>'}),define("text!templates/agreement/pay_request_methods_tpl.html",[],function(){return'\n<div class="close">X</div>\n<h2 class="pay_header">Where should we send your funds?</h2>\n{{#if bankAccounts}}\n<h3>Select bank account</h3>\n<ul class="payment_select_container">\n  <li>\n    {{#each bankAccounts}}\n    <input type="radio" class="select_bank_account" name="select_bank_account" value="{{credits_uri}}">\n    <p class="payment_select_info"><span>Routing:</span> {{routing_number}}</p>\n    <p class="payment_select_info"><span>Account:</span> *********{{last_four_digits account_number}}</p>\n    {{/each}}\n    <h2> \n  </li>\n</ul>\n{{else}}\n<h3>Please add a bank account in the <a href="/account#bankaccount">account</a> page to receive payment.</h3>\n{{/if}}'}),define("text!templates/agreement/pay_request_breakout.html",[],function(){return'<ul class="line_item_container">\n	<li class="line_item"><span class="line_item_title line_item_title_small">Milestone Amount:</span> ${{milestonePayment}}</li>\n	<li class="line_item"><span class="line_item_title line_item_title_small">Wurk Happy Fee:</span> ${{wurkHappyFee}}</li>\n	<li class="line_item line_item_total"><span class="line_item_title">You Will Receive:</span> ${{amountTotal}}</li>\n</ul>'}),define("views/agreement/read/modals/payment_request",["backbone","handlebars","text!templates/agreement/pay_request_tpl.html","text!templates/agreement/pay_request_methods_tpl.html","text!templates/agreement/pay_request_breakout.html"],function(e,t,n,r,i){t.registerHelper("last_four_digits",function(e){if(!e)return;return e.slice(-4)});var s=e.View.extend({template:t.compile(r),initialize:function(e){this.bankAccounts=e.bankAccounts,this.listenTo(this.bankAccounts,"add",this.render),this.render()},render:function(){return this.$el.html(this.template({bankAccounts:this.bankAccounts.toJSON()})),this}}),o=e.View.extend({template:t.compile(n),breakoutTpl:t.compile(i),initialize:function(e){this.bankAccounts=e.bankAccounts,this.bankAccounts.fetch(),this.paymentMethodsView=new s({bankAccounts:this.bankAccounts}),this.render()},render:function(e){this.$el.html(this.template(_.extend({payments:this.collection.toJSON()},this.calculatePayment()))),this.$("header").html(this.paymentMethodsView.$el)},events:{"click #pay-button":"requestPayment","change #milestoneToPay":"updateView"},calculatePayment:function(){var e=this.model.get("amount"),t=e*.05,n=e-t;return{milestonePayment:e,wurkHappyFee:t,amountTotal:n}},updateView:function(e){var t=e.target.value;this.model=this.collection.get(t),this.$("#paymentBreakout").html(this.breakoutTpl(this.calculatePayment()))},requestPayment:function(e){var t=function(){$("#overlay").fadeOut("fast")},n=function(){$("#notification_container").fadeIn("fast"),$("#notification_text").text("Payment requested and email sent")};$("#notification_container").hover(function(){$("#notification_container").fadeOut("fast")});var r=_.debounce(n,300);t(),r();var i=this.$(".select_bank_account:checked").attr("value")||"";this.trigger("paymentRequested",i),this.trigger("hide")}});return o}),define("views/ui-modules/modal",["backbone","handlebars"],function(e,t){var n='<div id="overlay" class="overlay hide"><div class="cover"></div><div id="panel" class="panel"><div class="close">X</div></div>',r=e.View.extend({attributes:{id:"popup_container"},template:n,holder:$("body"),initialize:function(e){this.view=e.view,this.listenTo(this.view,"hide",this.hide),this.listenTo(this.view,"close",this.remove),this.render()},render:function(e){this.$el.html(this.template),this.$("#panel").append(this.view.$el),this.holder.append(this.$el)},events:{"click .close":"hide","click .personal_message_link":"showPersonalMessage"},show:function(){this.$("#overlay").fadeIn("slow")},hide:function(e){this.$("#overlay").fadeOut("slow")},showPersonalMessage:function(){$(".panel").animate({left:"30%",width:"900px"},"fast"),$(".personal_message_helper").fadeOut("fast"),_.defer(function(){$(".personal_message_container").fadeIn("fast")})}});return r}),define("views/agreement/read/header_states/accepted_state",["backbone","handlebars","views/agreement/read/header_states/base_state","views/agreement/read/modals/payment_request","views/ui-modules/modal"],function(e,t,n,r,i){var s=n.extend({initialize:function(e){n.prototype.initialize.apply(this),this.button1Title=this.userIsClient?null:"Request Payment",this.button2Title=this.userIsClient?null:"Edit Agreement",this.user=e.user},button1:function(e){if(!this.modal){var t=new r({model:this.model.get("payments").findFirstOutstandingPayment(),collection:this.model.get("payments").findAllOutstandingPayment(),cards:this.user.get("cards"),bankAccounts:this.user.get("bank_accounts")});this.modal=new i({view:t}),this.listenTo(this.modal.view,"paymentRequested",this.paymentRequested)}this.modal.show()},button2:function(e){this.edit()},paymentRequested:function(e){this.modal.view.model.submit(e)}});return s}),define("views/agreement/read/header_states/created_state",["backbone","handlebars","views/agreement/read/header_states/base_state"],function(e,t,n){var r=n.extend({initialize:function(){n.prototype.initialize.apply(this),this.button1Title=this.userIsClient?null:"Submit Agreement",this.button2Title=this.userIsClient?null:"Edit Agreement"},button1:function(e){this.model.submit()},button2:function(e){this.edit()}});return r}),define("text!templates/agreement/accept_tpl.html",[],function(){return'<header class="bottom_divider pay_header_container">\n  <h2 class="pay_header">Payment Options</h2>\n  <span class="helper_text">Manage stored payment methods in the <a href="/account">account</a> section.</span>\n\n  <input type="radio" name="payment_type" value="credit_card" class="select_radio">Pay with stored credit card<br>\n  <ul id="credit_card" class="payment_select_container">\n    <li>\n      {{#each creditCards}}\n      <input type="radio" class="select_credit_card" name="select_credit_card" value="{{uri}}" data-url="{{uri}}">\n      <p class="payment_select_info">**** **** **** {{last_four}}</p>\n      <p class="payment_select_info"><span>Expiration:</span> {{expiration_month}}/{{expiration_year}}</p>\n      {{/each}}\n    </li>\n  </ul>\n  <input type="radio" name="payment_type" value="bank_account" class="select_radio">Pay with stored bank account<br>\n  <ul id="bank_account" class="payment_select_container">\n    <li>\n      {{#each bankAccounts}}\n      <input type="radio" class="select_bank_account" name="select_bank_account" value="{{uri}}">\n      <p class="payment_select_info"><span>Routing:</span> **** **** **** {{routing_number}}</p>\n      <p class="payment_select_info"><span>Account:</span> **** **** **** {{last_four_digits account_number}}</p>\n      {{/each}}\n    </li>\n  </ul>\n</header>\n<article>\n  <div class="line"></div>\n  <h2 class="pay_header pay_milestone">Pay Milestone "Deposit"</h2>\n  <div>\n    <ul class="line_item_container">\n      <li class="line_item"><span class="line_item_title line_item_title_small">Milestone Amount:</span> ${{milestonePayment}}</li>\n      <li class="line_item line_item_total"><span class="line_item_title">Payment Total:</span> ${{amountTotal}}</li>\n    </ul>\n  </div>\n  <a id="accept-button" class="button action_button pay_button">Pay</a>\n</article>'}),define("text!templates/agreement/reject_tpl.html",[],function(){return'<header class="bottom_divider pay_header_container">\n  <h2 class="pay_header">Please provide a reason you\'re rejecting this {{status}} request.</h2>\n  <form action="#" method="get" accept-charset="utf-8">\n    <fieldset>\n      <label for="reject">Dear {{otherUser.firstName}},</label> \n      <textarea name="proposedServices" rows="3" cols="40" placeholder="Please let your freelancer know why you\'re not approving this."></textarea>\n      <a id="reject-button" class="button cancel reject_button">Reject {{status}}</a>\n    </fieldset>\n  </form>\n</header>'}),define("views/agreement/read/modals/reject",["backbone","handlebars","text!templates/agreement/reject_tpl.html"],function(e,t,n){var r=e.View.extend({template:t.compile(n),initialize:function(e){this.otherUser=e.otherUser,this.render()},render:function(){this.$el.html(this.template({status:this.statusType,otherUser:this.otherUser}))},events:{"click #reject-button":"rejectRequest","blur textarea":"addMessage"},addMessage:function(e){this.message=e.target.value},rejectRequest:function(e){this.model.reject(this.message,_.bind(function(){this.trigger("hide")},this));var t;this.statusType?t=this.statusType:t="";var n=function(){$(".notification_container").fadeIn("fast"),$(".notification_text").text("Request "+t+" and email sent")};$(".notification_container").hover(function(){$(".notification_container").fadeOut("fast")});var r=_.debounce(n,300);this.trigger("hide"),r()}});return r}),define("views/agreement/read/modals/accept_payment",["backbone","handlebars","noty","noty-inline","noty-default","views/agreement/read/header_states/base_state","text!templates/agreement/accept_tpl.html","views/agreement/read/modals/reject","views/ui-modules/modal"],function(e,t,n,r,i,s,o,u,a){var f=e.View.extend({payTemplate:t.compile(o),initialize:function(e){this.button1Title=this.userIsClient?"Accept "+this.statusType:"Waiting for Response",this.user=e.user,this.user.get("cards").fetch(),this.user.get("bank_accounts").fetch(),this.otherUser=e.otherUser,this.render()},render:function(){var e=this.model.get("amount"),t=e,n=this.user.get("cards").toJSON(),r=this.user.get("bank_accounts").toJSON();this.$el.html(this.payTemplate({milestonePayment:e,amountTotal:t,creditCards:n,bankAccounts:r})),$(".payment_select_container").hide()},events:{"click #accept-button":"acceptRequest","click .select_radio":"selectPaymentMethod"},paymentTotal:function(e,t){return e-t},selectPaymentMethod:function(e){var t=$(e.target),n=t.val();$(".payment_select_container").not("#"+n).slideUp("fast"),$("#"+n).slideDown("fast")},acceptRequest:function(e){var t=$(".select_bank_account:checked").val()||$(".select_credit_card:checked").val()||"";this.model.accept(t);var n;this.statusType?n=this.statusType:n="";var r=function(){$("#notification_container").fadeIn("fast"),$("#notification_text").text("Request "+n+" and email sent")};$("#notification_container").hover(function(){$("#notification_container").fadeOut("fast")});var i=_.debounce(r,300);this.trigger("hide"),i()}});return f}),define("views/agreement/read/header_states/submitted_state",["backbone","handlebars","noty","noty-inline","noty-default","views/agreement/read/header_states/base_state","text!templates/agreement/accept_tpl.html","views/agreement/read/modals/reject","views/ui-modules/modal","views/agreement/read/modals/accept_payment"],function(e,t,n,r,i,s,o,u,a,f){var l=s.extend({payTemplate:t.compile(o),initialize:function(e){s.prototype.initialize.apply(this),this.button1Title=this.userIsClient?"Accept "+this.statusType:"Waiting for Response",this.button2Title=this.userIsClient?"Reject "+this.statusType:null,this.user=e.user,this.otherUser=e.otherUser},button1:function(e){if(!this.userIsClient)return;if(this.statusType==="payment"){if(!this.acceptModal){var t=new f({model:this.model.get("payments").findSubmittedPayment(),user:this.user,otherUser:this.otherUser});this.acceptModal=new a({view:t})}this.acceptModal.show()}else if(this.model.get("payments").findFirstRequiredPayment()){if(!this.depositModal){var t=new f({model:this.model.get("payments").findFirstRequiredPayment(),user:this.user,otherUser:this.otherUser});this.depositModal=new a({view:t})}this.depositModal.show()}else this.model.accept()},button2:function(e){var t=this.statusType==="payment"?this.model.get("payments").findFirstOutstandingPayment():this.model;if(!this.rejectModal){console.log("new reject");var n=new u({model:t,otherUser:this.otherUser});this.rejectModal=new a({view:n})}this.rejectModal.show()}});return l}),define("views/agreement/read/header_states/rejected_state",["backbone","handlebars","views/agreement/read/header_states/base_state"],function(e,t,n){var r=n.extend({initialize:function(){n.prototype.initialize.apply(this);var e=this.statusType==="payment"?"Request":"Submit";this.button1Title=this.userIsClient?null:e+" "+this.statusType,this.button2Title=this.userIsClient?null:"Edit Agreement"},button1:function(e){this.statusType==="payment"?this.model.get("payments").findFirstOutstandingPayment().submit():this.edit()},button2:function(e){window.location.hash="edit"}});return r}),define("views/agreement/read/header_states/draft_state",["backbone","handlebars","views/agreement/read/header_states/base_state"],function(e,t,n){var r=n.extend({initialize:function(){n.prototype.initialize.apply(this),this.button1Title=this.userIsClient?null:"Send Agreement",this.button2Title=this.userIsClient?null:"Edit Draft"},button1:function(e){this.model.set("draft",!1),this.model.save({},{success:_.bind(function(e,t){var n=function(){window.location="/home"};this.model.submit(n)},this)})},button2:function(e){window.location.hash="edit"}});return r}),define("views/agreement/read/header_view",["backbone","handlebars","noty","noty-inline","noty-default","text!templates/agreement/read/header_tpl.html","views/agreement/read/header_states/accepted_state","views/agreement/read/header_states/created_state","views/agreement/read/header_states/submitted_state","views/agreement/read/header_states/rejected_state","views/agreement/read/header_states/draft_state"],function(e,t,n,r,i,s,o,u,a,f,l){var c=e.View.extend({template:t.compile(s),initialize:function(e){this.listenTo(this.model,"change:currentStatus",this.changeState),this.user=e.user,this.otherUser=e.otherUser,this.changeState(),console.log(this.model)},render:function(){var e,t=this.model.get("currentStatus");return t!==null?this.state.button1Title===t.StatusWaiting&&(e=!0):e=!1,this.$el.html(this.template({model:this.model.toJSON(),button1Title:this.state.button1Title,button2Title:this.state.button2Title,waiting:e})),this},events:{"click #action-button1":"button1","click #action-button2":"button2"},button1:function(e){this.state.button1()},button2:function(e){this.state.button2()},changeState:function(){if(this.model.get("draft")){this.state=new l({model:this.model}),this.render();return}var e=this.model.get("currentStatus");switch(e.get("action")){case e.StatusCreated:this.state=new u({model:this.model});break;case e.StatusSubmitted:this.state=new a({model:this.model,user:this.user,otherUser:this.otherUser});break;case e.StatusAccepted:this.state=new o({model:this.model,user:this.user});break;case e.StatusRejected:this.state=new f({model:this.model});break;default:}this.render()}});return c}),define("text!templates/agreement/discussion_tpl.html",[],function(){return'<h2>Messages</h2>\n<h3 class="helper_text">We send out an email everytime you post a message.</h3>\n<ul class="discussion_container">\n	{{#if this.comments}}\n		<h2 class="discussion_placeholder">Have something important to say? Leave a message in the box below.</h2>\n	{{/if}}\n</ul>\n<div class="add_comment_container">\n	<textarea class="enter_comment_input inline" placeholder="Click here to leave a message."></textarea>\n	<div class="comment_action_container">\n		<div id="select" class="selectdiv">  \n			<select class="inline comment_select_padding selectboxdiv" id="milestoneSelect">\n				<option value="General" disabled selected>Choose Milestone...</option>\n				{{#each this.payments}}\n				<option value="{{id}}">{{title}}</option>\n				{{/each}}\n			</select>\n			<div class="out">Choose Milestone...</div>\n		</div>\n		<div id="action-select-wrapper" class="inline comment_select_padding"></div>\n		<a class="send_comment">Send</a>\n	</div>\n</div>'}),define("text!templates/agreement/action_select_tpl.html",[],function(){return'<select class="selectboxdiv" id="actionSelect">\n	<option value="" selected disabled >Choose Action...</option>\n	{{#each items}}\n	<option value="{{id}}">{{action}} on {{dateFormat date}}</option>\n	{{/each}}\n</select>\n<div class="out">Choose Action...</div>'}),define("views/agreement/action_select",["backbone","handlebars","underscore","marionette","moment","text!templates/agreement/action_select_tpl.html"],function(e,t,n,r,i,s){t.registerHelper("dateFormat",function(e){return e.format("MMM D, YYYY")});var o=e.Marionette.ItemView.extend({tagName:"div",attributes:{id:"actionSelect"},className:"selectdiv",template:t.compile(s),collectionEvents:{reset:"render"}});return o}),define("views/agreement/discussion_view",["backbone","handlebars","underscore","marionette","text!templates/agreement/discussion_tpl.html","views/agreement/comment_view","views/agreement/action_select"],function(e,t,n,r,i,s,o){var u=e.Marionette.CompositeView.extend({template:t.compile(i),itemView:s,itemViewOptions:function(e){return{agreement:this.model,user:this.user,otherUser:this.otherUser}},itemViewContainer:"ul",events:{"keypress input":"addComment","click .send_comment":"addComment","change #milestoneSelect":"updateMilestone","change #actionSelect":"updateStatus","focus select":"addSelectActive","blur select":"removeSelectActive","change select":"updateSelect"},initialize:function(e){this.userIsClient=window.thisUser.id===this.model.get("clientID"),this.collection=this.model.get("comments"),this.user=e.user,this.otherUser=e.otherUser},onRender:function(){this.actionSelect=(new o({collection:this.model.get("statusHistory").filterByPaymentID(this.milestone)})).render(),this.$("#action-select-wrapper").html(this.actionSelect.$el);var e=this.collection.at(this.collection.length-1);e&&(this.$("#milestoneSelect").val(e.get("milestoneID")).trigger("change"),this.$("#actionSelect").val(e.get("statusID")).trigger("change"))},addComment:function(e){var t=$("textarea.enter_comment_input");if(e.keyCode==13||e.type=="click"){var r=new this.collection.model({text:t.val(),dateCreated:moment(),userID:window.thisUser.id,milestoneID:this.milestone,statusID:this.status,agreementVersionID:this.collection.agreement.get("versionID")});this.collection.add(r),r.save(),t.val(""),t.focus(),$(".notification_container").last().fadeIn("slow").fadeOut(2e3),n.defer(function(){$(".discussion_container").scrollTop($(".discussion_container")[0].scrollHeight)})}},updateMilestone:function(e){this.milestone=e.target.value;var t=this.model.get("statusHistory").filterByPaymentID(this.milestone);this.actionSelect.collection=t,this.actionSelect.render()},updateStatus:function(e){this.status=e.target.value},updateSelect:function(e){var t=$(e.target),n=t.find(":selected").text();t.parent().find(".out").text(n)},addSelectActive:function(e){var t=$(e.target.parentNode);t.addClass("active_select")},removeSelectActive:function(e){var t=$(e.target.parentNode);t.removeClass("active_select")}});return u}),define("collections/cards",["backbone","models/comment"],function(e,t){var n=e.Collection.extend({model:t,url:function(){return"/user/"+this.user.id+"/cards"}});return n}),define("models/card",["backbone","backbone-relational"],function(e,t){var n=e.RelationalModel.extend({urlRoot:function(){return"/user/"+this.collection.user.id+"/cards"}});return n}),define("collections/bank_accounts",["backbone","models/comment"],function(e,t){var n=e.Collection.extend({model:t,url:function(){return"/user/"+this.user.id+"/bank_account"}});return n}),define("models/bank_account",["backbone","backbone-relational"],function(e,t){var n=e.RelationalModel.extend({urlRoot:function(){return"/user/"+this.collection.user.id+"/bank_account"},verify:function(e,t){$.ajax({type:"POST",url:this.url()+"/verify",contentType:"application/json",dataType:"json",data:JSON.stringify(e),success:_.bind(function(e){this.set("can_debit",!0),t(e)},this)})}});return n}),define("models/user",["backbone","collections/cards","models/card","collections/bank_accounts","models/bank_account"],function(e,t,n,r,i){var s=e.RelationalModel.extend({relations:[{type:e.HasMany,key:"cards",relatedModel:n,collectionType:t,reverseRelation:{key:"user",includeInJSON:!1}},{type:e.HasMany,key:"bank_accounts",relatedModel:i,collectionType:r,reverseRelation:{key:"user",includeInJSON:!1}}],url:function(){return this.id?"/user/"+this.id:"/user"}});return s}),define("text!templates/agreement/agreement_progress_bar_tpl.html",[],function(){return'<div class="progress-large">\n	<div class="icon_container">\n		<i class="fa fa-circle progress_icon" style="opacity:0;"></i>{{#each payments}}{{{midpoint @index ../this}}}<i class="fa fa circle progress_icon {{adjustIconColor currentStatus.action}}"></i>{{/each}}<i class="fa fa-circle progress_icon"style="opacity:0;"></i>\n	</div>\n	<progress class="agreement_progress" max="100" value="{{percentComplete}}" data-skill="html5">\n		<!-- Browsers that support HTML5 progress element will ignore the html inside `progress` element. Whereas older browsers will ignore the `progress` element and instead render the html inside it. -->\n		<p style="width:{{percentComplete}}%" data-value="{{percentComplete}}">HTML5</p>\n		<div class="agreement_progress_bar">\n			<span style="width: {{percentComplete}}%">{{percentComplete}}%</span>\n		</div>\n	</progress>\n</div>'}),define("views/agreement/progress_bar_view",["backbone","handlebars","underscore","marionette","text!templates/agreement/agreement_progress_bar_tpl.html"],function(e,t,n,r,i){t.registerHelper("adjustIconColor",function(e){return e==="submitted"?"yellow_progress":e==="accepted"?"green_progress":e==="rejected"?"red_progress":"grey_progress"}),t.registerHelper("midpoint",function(e,t){var n=t.payments.length;return n%2!=0||e!=n/2&&e!=n-.5?"":'<i class="fa fa-circle progress_icon" style="opacity:0;"></i>'});var s=e.View.extend({template:t.compile(i),initialize:function(e){this.payments=e.model.get("payments"),this.listenTo(this.payments,"change",this.render)},render:function(){var e=this.payments,t=e.getNumberOfSubmittedPayments(),n=e.getAcceptedPayments(),r=t+n,i=this.payments.length,s=this.calculatePercentage(i,r);return this.$el.html(this.template({payments:this.payments.toJSON(),percentComplete:s})),this.afterRender(),this},afterRender:function(){var e=30,t=this.payments,r=t.length,i=r%2==0?3:2,s=(r+i-1)*e;n.defer(function(){var t=900-s,n=$(".progress_icon"),o=t/(r+i-1);$(".progress_icon").css({"margin-left":o/2+"px","margin-right":o/2+"px"}),$(".progress_icon").first().css("margin-left",-(e/2)+"px"),$(".progress_icon").last().css("margin-right","0px"),$("progress").addClass("yellow_progress")})},calculatePercentage:function(e,t){var n=100,r=e%2==0?3:2,i=e+r-1;return t<1?0:t===e?100:n/i*t}});return s}),define("app/routers/agreement_router",["backbone","models/agreement","views/agreement/layout_manager","views/agreement/payments_read_view","views/agreement/agreement_history_view","views/agreement/user_view","views/agreement/edit/user_edit_view","views/agreement/edit/header_edit_view","views/agreement/edit/payments_edit_view","views/agreement/read/header_view","views/agreement/discussion_view","models/user","views/agreement/progress_bar_view"],function(e,t,n,r,i,s,o,u,a,f,l,c,h){var p=e.Router.extend({routes:{"":"readAgreement",edit:"editAgreement"},initialize:function(){this.model=new t(window.agreement),this.model.set("comments",window.comments),this.layout=new n({model:this.model}),this.user=new c(window.thisUser),this.otherUser=new c(window.otherUser),this.user.set("cards",window.cards),this.user.set("bank_accounts",window.bank_account)},readAgreement:function(){this.layout.agreementProgressBar.show(new h({model:this.model})),this.layout.paymentSchedule.show(new r({model:this.model})),this.layout.agreementHistory.show(new i({model:this.model})),this.layout.profile.show(new s),this.layout.header.show(new f({model:this.model,user:this.user,otherUser:this.otherUser})),this.layout.discussion.show(new l({model:this.model,user:this.user,otherUser:this.otherUser})),this.model.sample&&this.sample()},editAgreement:function(){this.layout.header.show(new u({model:this.model,user:this.user})),this.layout.paymentSchedule.show(new a({model:this.model})),this.layout.profile.show(new o({model:this.model}))},sample:function(){}});return p}),define("app/mainagreement",["require","app/routers/agreement_router"],function(e){var t=e("app/routers/agreement_router");$(function(){var e=new t;Backbone.history.start({pushState:!1})})});